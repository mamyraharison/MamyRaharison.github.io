<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FootManager Pro - Gestion de Terrain</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover { transition: all 0.15s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .slot-free { background: linear-gradient(135deg, #10b981, #059669); }
        .slot-reserved { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .slot-paid { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .animate-fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md animate-fade-in">
            <div class="text-center mb-8">
                <div class="bg-green-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-futbol text-green-600 text-2xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-800">FootManager Pro</h1>
                <p class="text-gray-600 mt-2">Gestion moderne de terrain de foot</p>
            </div>
            
            <form onsubmit="login(event)" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nom d'utilisateur</label>
                    <input type="text" id="username" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mot de passe</label>
                    <input type="password" id="password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Rôle</label>
                    <select id="role" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                        <option value="receptionniste">Réceptionniste</option>
                        <option value="proprietaire">Propriétaire</option>
                    </select>
                </div>
                
                <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 rounded-lg font-semibold hover:from-blue-700 hover:to-purple-700 transition-all transform hover:scale-105">
                    Se connecter
                </button>
            </form>
            
            <div class="mt-6 text-center text-sm text-gray-500">
                <p><strong>Propriétaire:</strong> admin / admin</p>
                <p><strong>Réceptionniste:</strong> user / user</p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Sidebar -->
        <div class="fixed inset-y-0 left-0 w-64 bg-white shadow-lg z-50">
            <div class="flex items-center justify-center h-16 border-b border-gray-200">
                <div class="flex items-center space-x-2">
                    <div class="bg-green-100 w-8 h-8 rounded-full flex items-center justify-center">
                        <i class="fas fa-futbol text-green-600"></i>
                    </div>
                    <span class="text-xl font-bold text-gray-800">FootManager</span>
                </div>
            </div>
            
            <nav class="mt-8">
                <div class="px-4 mb-4">
                    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Menu Principal</p>
                </div>
                
                <a href="#" onclick="showPage('dashboard')" class="nav-item flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-all">
                    <i class="fas fa-chart-line w-5 h-5 mr-3"></i>
                    Tableau de bord
                </a>
                
                <a href="#" onclick="showPage('reservations')" class="nav-item flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-all">
                    <i class="fas fa-calendar-alt w-5 h-5 mr-3"></i>
                    Réservations
                </a>
                
                <a href="#" onclick="showPage('caisse')" class="nav-item flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-all">
                    <i class="fas fa-cash-register w-5 h-5 mr-3"></i>
                    Caisse
                </a>
                
                <a href="#" onclick="showPage('historique')" class="nav-item flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-all">
                    <i class="fas fa-history w-5 h-5 mr-3"></i>
                    Historique
                </a>
                
                <a href="#" onclick="showPage('clients')" class="nav-item flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-all">
                    <i class="fas fa-users w-5 h-5 mr-3"></i>
                    Clients
                </a>
                
                <a href="#" id="statsLink" onclick="showPage('statistiques')" class="nav-item hidden flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-all">
                    <i class="fas fa-chart-pie w-5 h-5 mr-3"></i>
                    Statistiques
                </a>
                
                <a href="#" id="databaseLink" onclick="showPage('database')" class="nav-item hidden flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-all">
                    <i class="fas fa-database w-5 h-5 mr-3"></i>
                    Base de Données
                </a>
                
                <a href="#" id="adminLink" onclick="showPage('administration')" class="nav-item hidden flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-all">
                    <i class="fas fa-cog w-5 h-5 mr-3"></i>
                    Administration
                </a>
            </nav>
            
            <div class="absolute bottom-0 w-full p-4 border-t border-gray-200">
                <div class="flex items-center space-x-3">
                    <div class="bg-blue-100 w-10 h-10 rounded-full flex items-center justify-center">
                        <i class="fas fa-user text-blue-600"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-800" id="userInfo">Utilisateur</p>
                        <button onclick="logout()" class="text-xs text-gray-500 hover:text-red-500 transition-colors">Déconnexion</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="ml-64 min-h-screen bg-gray-50">
            <!-- Header -->
            <header class="bg-white shadow-sm border-b border-gray-200 px-6 py-4">
                <div class="flex items-center justify-between">
                    <h1 id="pageTitle" class="text-2xl font-bold text-gray-800">Tableau de bord</h1>
                    <div class="flex items-center space-x-4">
                        <!-- Indicateur Git -->
                        <div class="flex items-center space-x-2">
                            <div id="gitStatusHeader" class="flex items-center space-x-2">
                                <div class="w-3 h-3 bg-gray-400 rounded-full"></div>
                                <span class="text-sm text-gray-500">GitHub</span>
                            </div>
                            <button onclick="githubStorage.pushToGitHub()" class="text-gray-800 hover:text-gray-900 transition-colors" title="Sauvegarder sur GitHub">
                                <i class="fab fa-github text-sm"></i>
                            </button>
                            <button onclick="refreshAllData()" class="text-blue-600 hover:text-blue-800 transition-colors" title="Actualiser les données">
                                <i class="fas fa-sync-alt text-sm"></i>
                            </button>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-500">Aujourd'hui</p>
                            <p class="text-lg font-semibold text-gray-800" id="currentDate"></p>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Dashboard Page -->
            <div id="dashboardPage" class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow-sm p-6 card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Réservations aujourd'hui</p>
                                <p class="text-3xl font-bold text-blue-600" id="todayReservations">0</p>
                            </div>
                            <div class="bg-blue-100 w-12 h-12 rounded-lg flex items-center justify-center">
                                <i class="fas fa-calendar-check text-blue-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm p-6 card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Recettes du jour</p>
                                <p class="text-3xl font-bold text-green-600" id="todayRevenue">0€</p>
                            </div>
                            <div class="bg-green-100 w-12 h-12 rounded-lg flex items-center justify-center">
                                <i class="fas fa-euro-sign text-green-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm p-6 card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Dépenses du jour</p>
                                <p class="text-3xl font-bold text-red-600" id="todayExpenses">0€</p>
                            </div>
                            <div class="bg-red-100 w-12 h-12 rounded-lg flex items-center justify-center">
                                <i class="fas fa-minus-circle text-red-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm p-6 card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Solde caisse</p>
                                <p class="text-3xl font-bold text-purple-600" id="cashBalance">0€</p>
                            </div>
                            <div class="bg-purple-100 w-12 h-12 rounded-lg flex items-center justify-center">
                                <i class="fas fa-wallet text-purple-600 text-xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Créneaux d'aujourd'hui</h3>
                        <div class="space-y-3" id="todaySlots">
                            <!-- Slots will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Activité récente</h3>
                        <div class="space-y-4" id="recentActivity">
                            <!-- Activity will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reservations Page -->
            <div id="reservationsPage" class="p-6 hidden">
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-semibold text-gray-800">Créneaux de réservation</h3>
                        <div class="flex items-center space-x-4 flex-wrap gap-2">
                            <input type="date" id="reservationDate" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <select id="slotStatusFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" onchange="loadReservations()">
                                <option value="all">Tous les créneaux</option>
                                <option value="free">Créneaux libres</option>
                                <option value="reserved">Créneaux réservés</option>
                                <option value="paid">Créneaux payés</option>
                            </select>
                            <div class="flex items-center space-x-2 text-sm">
                                <div class="flex items-center space-x-1">
                                    <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                    <span>Libre</span>
                                </div>
                                <div class="flex items-center space-x-1">
                                    <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                                    <span>Réservé</span>
                                </div>
                                <div class="flex items-center space-x-1">
                                    <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                                    <span>Payé</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="timeSlots">
                        <!-- Time slots will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Caisse Page -->
            <div id="caissePage" class="p-6 hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Transactions récentes</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="border-b border-gray-200">
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Date</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Type</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Description</th>
                                            <th class="text-right py-3 px-4 font-medium text-gray-600">Montant</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transactionsList">
                                        <!-- Transactions will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Ajouter une dépense</h3>
                            <form onsubmit="addExpense(event)" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                    <input type="text" id="expenseDescription" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Montant (Ar)</label>
                                    <input type="number" id="expenseAmount" step="100" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Catégorie</label>
                                    <select id="expenseCategory" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="maintenance">Maintenance</option>
                                        <option value="equipement">Équipement</option>
                                        <option value="utilities">Factures</option>
                                        <option value="other">Autre</option>
                                    </select>
                                </div>
                                
                                <button type="submit" class="w-full bg-red-600 text-white py-2 rounded-lg font-medium hover:bg-red-700 transition-colors">
                                    Enregistrer la dépense
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Historique Page -->
            <div id="historiquePage" class="p-6 hidden">
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-semibold text-gray-800">Historique complet</h3>
                        <div class="flex items-center space-x-4 flex-wrap gap-2">
                            <select id="periodFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" onchange="updatePeriodInputs()">
                                <option value="custom">Période personnalisée</option>
                                <option value="today">Aujourd'hui</option>
                                <option value="week">Cette semaine</option>
                                <option value="month">Ce mois</option>
                                <option value="year">Cette année</option>
                            </select>
                            <div id="customDateInputs" class="flex items-center space-x-2">
                                <input type="date" id="historyStartDate" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <input type="date" id="historyEndDate" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <select id="historyFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="all">Tout</option>
                                <option value="reservations">Réservations</option>
                                <option value="income">Recettes</option>
                                <option value="expenses">Dépenses</option>
                            </select>
                            <button onclick="exportHistory()" class="bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700 transition-colors">
                                <i class="fas fa-download mr-2"></i>Exporter
                            </button>
                            <button onclick="deleteSelectedHistory()" class="bg-red-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-700 transition-colors">
                                <i class="fas fa-trash mr-2"></i>Supprimer sélection
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-center py-3 px-2 font-medium text-gray-600">
                                        <input type="checkbox" id="selectAllHistory" onchange="toggleAllHistorySelection()" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    </th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Date</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Type</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Client/Description</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Créneau</th>
                                    <th class="text-right py-3 px-4 font-medium text-gray-600">Montant</th>
                                    <th class="text-center py-3 px-4 font-medium text-gray-600">Statut</th>
                                    <th class="text-center py-3 px-4 font-medium text-gray-600">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="historyList">
                                <!-- History will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Clients Page -->
            <div id="clientsPage" class="p-6 hidden">
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-semibold text-gray-800">Gestion des clients</h3>
                        <button onclick="openClientModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors">
                            <i class="fas fa-plus mr-2"></i>Nouveau client
                        </button>
                    </div>
                    
                    <div class="mb-4">
                        <input type="text" id="clientSearch" placeholder="Rechercher un client..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" onkeyup="searchClients()">
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Nom</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Téléphone</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Email</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Réservations</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Dernière visite</th>
                                    <th class="text-center py-3 px-4 font-medium text-gray-600">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="clientsList">
                                <!-- Clients will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Database Page -->
            <div id="databasePage" class="p-6 hidden">
                <!-- Onglets de navigation -->
                <div class="bg-white rounded-xl shadow-sm mb-6">
                    <div class="border-b border-gray-200">
                        <nav class="flex space-x-8 px-6">
                            <button onclick="showDatabaseTab('reservations')" class="database-tab py-4 px-2 border-b-2 border-blue-500 text-blue-600 font-medium text-sm">
                                <i class="fas fa-calendar-alt mr-2"></i>Réservations
                            </button>
                            <button onclick="showDatabaseTab('transactions')" class="database-tab py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">
                                <i class="fas fa-receipt mr-2"></i>Transactions
                            </button>
                            <button onclick="showDatabaseTab('clients')" class="database-tab py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">
                                <i class="fas fa-users mr-2"></i>Clients
                            </button>
                            <button onclick="showDatabaseTab('credentials')" class="database-tab py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">
                                <i class="fas fa-key mr-2"></i>Identifiants
                            </button>
                            <button onclick="showDatabaseTab('logs')" class="database-tab py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">
                                <i class="fas fa-history mr-2"></i>Logs
                            </button>
                        </nav>
                    </div>
                </div>

                <!-- Contenu des onglets -->
                <div id="databaseContent">
                    <!-- Onglet Réservations -->
                    <div id="dbReservationsTab" class="database-tab-content">
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-lg font-semibold text-gray-800">
                                    <i class="fas fa-calendar-alt text-blue-600 mr-2"></i>
                                    Table des Réservations
                                </h3>
                                <div class="flex space-x-3">
                                    <button onclick="addNewReservation()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors">
                                        <i class="fas fa-plus mr-2"></i>Ajouter
                                    </button>
                                    <button onclick="exportTable('reservations')" class="bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700 transition-colors">
                                        <i class="fas fa-download mr-2"></i>Exporter
                                    </button>
                                </div>
                            </div>
                            
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="border-b border-gray-200 bg-gray-50">
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">ID</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Date</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Heure</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Client</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Téléphone</th>
                                            <th class="text-right py-3 px-4 font-medium text-gray-600">Montant</th>
                                            <th class="text-center py-3 px-4 font-medium text-gray-600">Payé</th>
                                            <th class="text-center py-3 px-4 font-medium text-gray-600">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dbReservationsList">
                                        <!-- Sera rempli par JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Onglet Transactions -->
                    <div id="dbTransactionsTab" class="database-tab-content hidden">
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-lg font-semibold text-gray-800">
                                    <i class="fas fa-receipt text-green-600 mr-2"></i>
                                    Table des Transactions
                                </h3>
                                <div class="flex space-x-3">
                                    <button onclick="addNewTransaction()" class="bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700 transition-colors">
                                        <i class="fas fa-plus mr-2"></i>Ajouter
                                    </button>
                                    <button onclick="exportTable('transactions')" class="bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700 transition-colors">
                                        <i class="fas fa-download mr-2"></i>Exporter
                                    </button>
                                </div>
                            </div>
                            
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="border-b border-gray-200 bg-gray-50">
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">ID</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Date</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Type</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Description</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Catégorie</th>
                                            <th class="text-right py-3 px-4 font-medium text-gray-600">Montant</th>
                                            <th class="text-center py-3 px-4 font-medium text-gray-600">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dbTransactionsList">
                                        <!-- Sera rempli par JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Onglet Clients -->
                    <div id="dbClientsTab" class="database-tab-content hidden">
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-lg font-semibold text-gray-800">
                                    <i class="fas fa-users text-purple-600 mr-2"></i>
                                    Table des Clients
                                </h3>
                                <div class="flex space-x-3">
                                    <button onclick="addNewClient()" class="bg-purple-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-purple-700 transition-colors">
                                        <i class="fas fa-plus mr-2"></i>Ajouter
                                    </button>
                                    <button onclick="exportTable('clients')" class="bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700 transition-colors">
                                        <i class="fas fa-download mr-2"></i>Exporter
                                    </button>
                                </div>
                            </div>
                            
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="border-b border-gray-200 bg-gray-50">
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">ID</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Nom</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Téléphone</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Email</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Adresse</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Créé le</th>
                                            <th class="text-center py-3 px-4 font-medium text-gray-600">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dbClientsList">
                                        <!-- Sera rempli par JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Onglet Identifiants -->
                    <div id="dbCredentialsTab" class="database-tab-content hidden">
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-lg font-semibold text-gray-800">
                                    <i class="fas fa-key text-orange-600 mr-2"></i>
                                    Table des Identifiants
                                </h3>
                                <div class="flex space-x-3">
                                    <button onclick="exportTable('credentials')" class="bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700 transition-colors">
                                        <i class="fas fa-download mr-2"></i>Exporter
                                    </button>
                                </div>
                            </div>
                            
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="border-b border-gray-200 bg-gray-50">
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Rôle</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Nom d'utilisateur</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Mot de passe</th>
                                            <th class="text-center py-3 px-4 font-medium text-gray-600">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dbCredentialsList">
                                        <!-- Sera rempli par JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Onglet Logs -->
                    <div id="dbLogsTab" class="database-tab-content hidden">
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-lg font-semibold text-gray-800">
                                    <i class="fas fa-history text-red-600 mr-2"></i>
                                    Table des Logs d'Activité
                                </h3>
                                <div class="flex space-x-3">
                                    <button onclick="clearAllLogs()" class="bg-red-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-700 transition-colors">
                                        <i class="fas fa-trash mr-2"></i>Vider logs
                                    </button>
                                    <button onclick="exportTable('logs')" class="bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700 transition-colors">
                                        <i class="fas fa-download mr-2"></i>Exporter
                                    </button>
                                </div>
                            </div>
                            
                            <div class="overflow-x-auto max-h-96 overflow-y-auto">
                                <table class="w-full">
                                    <thead class="sticky top-0 bg-white">
                                        <tr class="border-b border-gray-200 bg-gray-50">
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">ID</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Date/Heure</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Utilisateur</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Rôle</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Action</th>
                                            <th class="text-left py-3 px-4 font-medium text-gray-600">Détails</th>
                                            <th class="text-center py-3 px-4 font-medium text-gray-600">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dbLogsList">
                                        <!-- Sera rempli par JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Administration Page -->
            <div id="administrationPage" class="p-6 hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <!-- Configuration des prix -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <i class="fas fa-money-bill-wave text-green-600 mr-2"></i>
                            Configuration des prix
                        </h3>
                        
                        <div class="space-y-4">
                            <div class="border border-gray-200 rounded-lg p-4">
                                <h4 class="font-medium text-gray-800 mb-3">Prix par créneau (30 minutes)</h4>
                                <form onsubmit="updateSlotPrice(event)" class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Prix en Ariary</label>
                                        <input type="number" id="slotPriceInput" step="100" min="1000" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg font-medium hover:bg-green-700 transition-colors">
                                        Mettre à jour le prix
                                    </button>
                                </form>
                                <div class="mt-3 p-3 bg-green-50 rounded-lg">
                                    <p class="text-sm text-green-800">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        Prix actuel: <span class="font-bold" id="currentSlotPrice">${slotPrice.toLocaleString('fr-FR')} Ar</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Gestion des identifiants -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <i class="fas fa-key text-blue-600 mr-2"></i>
                            Gestion des identifiants
                        </h3>
                        
                        <div class="space-y-6">
                            <!-- Propriétaire -->
                            <div class="border border-gray-200 rounded-lg p-4">
                                <h4 class="font-medium text-gray-800 mb-3">Compte Propriétaire</h4>
                                <form onsubmit="updateCredentials(event, 'proprietaire')" class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Nom d'utilisateur</label>
                                        <input type="text" id="adminUsername" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Mot de passe</label>
                                        <input type="password" id="adminPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                    <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors">
                                        Modifier les identifiants propriétaire
                                    </button>
                                </form>
                            </div>
                            
                            <!-- Réceptionniste -->
                            <div class="border border-gray-200 rounded-lg p-4">
                                <h4 class="font-medium text-gray-800 mb-3">Compte Réceptionniste</h4>
                                <form onsubmit="updateCredentials(event, 'receptionniste')" class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Nom d'utilisateur</label>
                                        <input type="text" id="userUsername" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Mot de passe</label>
                                        <input type="password" id="userPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg font-medium hover:bg-green-700 transition-colors">
                                        Modifier les identifiants réceptionniste
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Gestion GitHub Réel -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <i class="fab fa-github text-gray-800 mr-2"></i>
                            Synchronisation GitHub
                        </h3>
                        
                        <div class="space-y-4">
                            <!-- Statut GitHub -->
                            <div class="bg-blue-50 rounded-lg p-3">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-700">Statut GitHub:</span>
                                    <div id="githubStatus" class="flex items-center space-x-2">
                                        <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                                        <span class="text-sm text-blue-600">Connecté</span>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <span class="text-xs text-gray-500">Repository: </span>
                                    <span class="text-xs font-mono bg-gray-200 px-2 py-1 rounded">TolojanaharyFrancko/footmanager-data</span>
                                </div>
                                <div class="mt-1">
                                    <span class="text-xs text-gray-500">Fichier: </span>
                                    <span class="text-xs font-mono bg-gray-200 px-2 py-1 rounded">footmanager-data.json</span>
                                </div>
                                <div class="mt-1">
                                    <span class="text-xs text-gray-500">Mode: </span>
                                    <span class="text-xs font-mono bg-blue-200 px-2 py-1 rounded text-blue-800">Authentifié avec token</span>
                                </div>
                            </div>
                            
                            <!-- Actions GitHub -->
                            <div class="space-y-3">
                                <button onclick="githubStorage.testGitHubConnection()" class="w-full bg-purple-600 text-white py-2 rounded-lg font-medium hover:bg-purple-700 transition-colors">
                                    <i class="fas fa-plug mr-2"></i>
                                    Tester la connexion
                                </button>
                                
                                <button onclick="githubStorage.pushToGitHub()" class="w-full bg-gray-800 text-white py-2 rounded-lg font-medium hover:bg-gray-900 transition-colors">
                                    <i class="fab fa-github mr-2"></i>
                                    Sauvegarder sur GitHub
                                </button>
                                
                                <button onclick="githubStorage.pullFromGitHub()" class="w-full bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors">
                                    <i class="fas fa-download mr-2"></i>
                                    Charger depuis GitHub
                                </button>
                                
                                <div class="grid grid-cols-2 gap-2">
                                    <button onclick="githubStorage.toggleAutoSync()" class="bg-green-600 text-white py-2 rounded-lg font-medium hover:bg-green-700 transition-colors text-sm">
                                        <i class="fas fa-sync-alt mr-1"></i>
                                        <span id="githubAutoSyncText">Auto sync</span>
                                    </button>
                                    <button onclick="githubStorage.resetGitHubToken()" class="bg-orange-600 text-white py-2 rounded-lg font-medium hover:bg-orange-700 transition-colors text-sm">
                                        <i class="fas fa-key mr-1"></i>
                                        Nouveau token
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Statistiques GitHub -->
                            <div class="grid grid-cols-2 gap-3 text-center">
                                <div class="bg-gray-50 rounded-lg p-2">
                                    <p class="text-lg font-bold text-gray-600" id="githubPendingChanges">0</p>
                                    <p class="text-xs text-gray-800">Modifications</p>
                                </div>
                                <div class="bg-green-50 rounded-lg p-2">
                                    <p class="text-lg font-bold text-green-600" id="githubLastSync">Jamais</p>
                                    <p class="text-xs text-green-800">Dernière sync</p>
                                </div>
                            </div>
                            

                        </div>
                    </div>
                    
                    <!-- Gestion des données -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <i class="fas fa-database text-green-600 mr-2"></i>
                            Gestion des données locales
                        </h3>
                        
                        <div class="space-y-4">
                            <!-- Statistiques des données -->
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-blue-50 rounded-lg p-3 text-center">
                                    <p class="text-2xl font-bold text-blue-600" id="totalReservationsCount">0</p>
                                    <p class="text-sm text-blue-800">Réservations</p>
                                </div>
                                <div class="bg-green-50 rounded-lg p-3 text-center">
                                    <p class="text-2xl font-bold text-green-600" id="totalTransactionsCount">0</p>
                                    <p class="text-sm text-green-800">Transactions</p>
                                </div>
                                <div class="bg-purple-50 rounded-lg p-3 text-center">
                                    <p class="text-2xl font-bold text-purple-600" id="totalClientsCount">0</p>
                                    <p class="text-sm text-purple-800">Clients</p>
                                </div>
                                <div class="bg-orange-50 rounded-lg p-3 text-center">
                                    <p class="text-2xl font-bold text-orange-600" id="totalDataSize">0</p>
                                    <p class="text-sm text-orange-800">Ko stockés</p>
                                </div>
                            </div>
                            
                            <!-- Actions sur les données -->
                            <div class="space-y-3">
                                <!-- Export/Import des données -->
                                <button onclick="exportAllData()" class="w-full bg-green-600 text-white py-2 rounded-lg font-medium hover:bg-green-700 transition-colors">
                                    <i class="fas fa-download mr-2"></i>
                                    Exporter toutes les données
                                </button>
                                
                                <div class="flex space-x-2">
                                    <input type="file" id="importFileInput" accept=".json" class="hidden" onchange="importData(event)">
                                    <button onclick="document.getElementById('importFileInput').click()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors">
                                        <i class="fas fa-upload mr-2"></i>
                                        Importer des données
                                    </button>
                                    <button onclick="exportLocalData()" class="flex-1 bg-purple-600 text-white py-2 rounded-lg font-medium hover:bg-purple-700 transition-colors">
                                        <i class="fas fa-file-export mr-2"></i>
                                        Export local
                                    </button>
                                </div>
                                
                                <!-- Réinitialisations spécifiques -->
                                <div class="border-t pt-3 mt-4">
                                    <h5 class="text-sm font-medium text-gray-700 mb-2">Réinitialisation sélective</h5>
                                    <div class="grid grid-cols-3 gap-2 mb-3">
                                        <button onclick="resetSpecificData('reservations')" class="bg-orange-500 text-white py-1 px-2 rounded text-xs font-medium hover:bg-orange-600 transition-colors">
                                            <i class="fas fa-calendar-times mr-1"></i>
                                            Réservations
                                        </button>
                                        <button onclick="resetSpecificData('transactions')" class="bg-purple-500 text-white py-1 px-2 rounded text-xs font-medium hover:bg-purple-600 transition-colors">
                                            <i class="fas fa-receipt mr-1"></i>
                                            Transactions
                                        </button>
                                        <button onclick="resetSpecificData('clients')" class="bg-indigo-500 text-white py-1 px-2 rounded text-xs font-medium hover:bg-indigo-600 transition-colors">
                                            <i class="fas fa-users mr-1"></i>
                                            Clients
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Réinitialisation complète -->
                                <button onclick="resetAllData()" class="w-full bg-red-600 text-white py-2 rounded-lg font-medium hover:bg-red-700 transition-colors border-2 border-red-700">
                                    <i class="fas fa-exclamation-triangle mr-2"></i>
                                    RÉINITIALISATION COMPLÈTE
                                </button>
                                <p class="text-xs text-red-600 text-center">⚠️ Supprime TOUTES les données</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Logs d'activité -->
                <div class="bg-white rounded-xl shadow-sm p-6 mt-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-history text-gray-600 mr-2"></i>
                        Logs d'activité récente
                    </h3>
                    
                    <div class="overflow-x-auto max-h-64 overflow-y-auto">
                        <table class="w-full">
                            <thead class="sticky top-0 bg-white">
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-2 px-4 font-medium text-gray-600">Date/Heure</th>
                                    <th class="text-left py-2 px-4 font-medium text-gray-600">Utilisateur</th>
                                    <th class="text-left py-2 px-4 font-medium text-gray-600">Action</th>
                                    <th class="text-left py-2 px-4 font-medium text-gray-600">Détails</th>
                                </tr>
                            </thead>
                            <tbody id="activityLogs">
                                <!-- Logs will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Statistiques Page -->
            <div id="statistiquesPage" class="p-6 hidden">
                <!-- Filtres de période -->
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Analyse des transactions</h3>
                        <div class="flex items-center space-x-4">
                            <select id="statsTimeFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" onchange="updateStatsView()">
                                <option value="day">Par jour</option>
                                <option value="month" selected>Par mois</option>
                                <option value="year">Par année</option>
                            </select>
                            <button onclick="generateReport()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors">
                                <i class="fas fa-file-alt mr-2"></i>Générer bilan
                            </button>
                            <button onclick="exportJournal()" class="bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700 transition-colors">
                                <i class="fas fa-download mr-2"></i>Exporter journal
                            </button>
                        </div>
                    </div>
                    
                    <!-- Résumé des transactions -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4" id="statsOverview">
                        <!-- Sera rempli par JavaScript -->
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Revenus vs Dépenses</h3>
                        <canvas id="revenueChart" width="400" height="200"></canvas>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Créneaux populaires</h3>
                        <canvas id="slotsChart" width="400" height="200"></canvas>
                    </div>
                </div>
                
                <!-- Bilan détaillé -->
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Bilan financier détaillé</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Période</th>
                                    <th class="text-right py-3 px-4 font-medium text-gray-600">Entrées</th>
                                    <th class="text-right py-3 px-4 font-medium text-gray-600">Sorties</th>
                                    <th class="text-right py-3 px-4 font-medium text-gray-600">Solde</th>
                                    <th class="text-right py-3 px-4 font-medium text-gray-600">Évolution</th>
                                </tr>
                            </thead>
                            <tbody id="financialSummary">
                                <!-- Sera rempli par JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Journal des transactions -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Journal des transactions</h3>
                    <div class="overflow-x-auto max-h-96 overflow-y-auto">
                        <table class="w-full">
                            <thead class="sticky top-0 bg-white">
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Date</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Description</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Catégorie</th>
                                    <th class="text-right py-3 px-4 font-medium text-gray-600">Entrées</th>
                                    <th class="text-right py-3 px-4 font-medium text-gray-600">Sorties</th>
                                    <th class="text-right py-3 px-4 font-medium text-gray-600">Solde cumulé</th>
                                </tr>
                            </thead>
                            <tbody id="transactionJournal">
                                <!-- Sera rempli par JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md mx-4 animate-fade-in">
            <div class="flex items-center justify-center mb-4">
                <div class="bg-red-100 w-16 h-16 rounded-full flex items-center justify-center">
                    <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
                </div>
            </div>
            
            <h3 class="text-xl font-bold text-gray-800 text-center mb-4">Erreur d'authentification</h3>
            
            <div id="errorMessage" class="text-gray-600 text-center mb-6 leading-relaxed">
                <!-- Error message will be inserted here -->
            </div>
            
            <button onclick="closeErrorModal()" class="w-full bg-red-600 text-white py-3 rounded-lg font-semibold hover:bg-red-700 transition-all transform hover:scale-105">
                Réessayer
            </button>
        </div>
    </div>

    <!-- Client Modal -->
    <div id="clientModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md mx-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800" id="clientModalTitle">Nouveau client</h3>
                <button onclick="closeClientModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form onsubmit="saveClient(event)" class="space-y-4">
                <input type="hidden" id="clientId">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nom complet *</label>
                    <input type="text" id="clientFullName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Téléphone *</label>
                    <input type="tel" id="clientPhoneNumber" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="clientEmail" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Adresse</label>
                    <textarea id="clientAddress" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date de naissance</label>
                    <input type="date" id="clientBirthDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                    <textarea id="clientNotes" rows="2" placeholder="Notes sur le client..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                </div>
                
                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="closeClientModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg font-medium hover:bg-gray-400 transition-colors">
                        Annuler
                    </button>
                    <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors">
                        Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Client Details Modal -->
    <div id="clientDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-gray-800">Détails du client</h3>
                <button onclick="closeClientDetailsModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="font-semibold text-gray-800 mb-3">Informations personnelles</h4>
                    <div id="clientDetailsInfo" class="space-y-2">
                        <!-- Client info will be populated -->
                    </div>
                    <div class="mt-4 flex space-x-2">
                        <button onclick="editClientFromDetails()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition-colors">
                            <i class="fas fa-edit mr-1"></i>Modifier
                        </button>
                        <button onclick="deleteClientFromDetails()" class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700 transition-colors">
                            <i class="fas fa-trash mr-1"></i>Supprimer
                        </button>
                    </div>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-4">
                    <h4 class="font-semibold text-gray-800 mb-3">Historique des réservations</h4>
                    <div id="clientReservationsHistory" class="space-y-2 max-h-64 overflow-y-auto">
                        <!-- Reservations history will be populated -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reservation Modal -->
    <div id="reservationModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md mx-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Nouvelle réservation</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form onsubmit="saveReservation(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Créneau de départ</label>
                    <input type="text" id="modalSlot" readonly class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nombre de créneaux consécutifs</label>
                    <select id="consecutiveSlots" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" onchange="updateReservationAmount()">
                        <option value="1">1 créneau (30 min)</option>
                        <option value="2">2 créneaux (1h)</option>
                        <option value="3">3 créneaux (1h30)</option>
                        <option value="4">4 créneaux (2h)</option>
                        <option value="5">5 créneaux (2h30)</option>
                        <option value="6">6 créneaux (3h)</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Client</label>
                    <div class="flex space-x-2">
                        <select id="existingClient" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" onchange="selectExistingClient()">
                            <option value="">Sélectionner un client existant</option>
                        </select>
                        <button type="button" onclick="openClientModalFromReservation()" class="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 transition-colors">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nom du client</label>
                    <input type="text" id="clientName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Numéro de téléphone</label>
                    <input type="tel" id="clientPhone" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Montant (Ar)</label>
                    <input type="number" id="reservationAmount" step="100" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" readonly>
                    <p class="text-xs text-gray-500 mt-1" id="priceInfo">Prix calculé automatiquement selon le nombre de créneaux</p>
                </div>
                
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="isPaid" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <label for="isPaid" class="text-sm text-gray-700">Paiement effectué</label>
                </div>
                
                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg font-medium hover:bg-gray-400 transition-colors">
                        Annuler
                    </button>
                    <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors">
                        Réserver
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let currentPage = 'dashboard';
        let reservations = JSON.parse(localStorage.getItem('reservations')) || [];
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let clients = JSON.parse(localStorage.getItem('clients')) || [];
        let currentSlot = null;
        let currentClientId = null;
        let isEditingClient = false;
        let slotPrice = parseInt(localStorage.getItem('slotPrice')) || 30000; // Prix par créneau en Ariary



        // Fonctions d'export/import des données
        function exportAllData() {
            const allData = {
                reservations: reservations,
                transactions: transactions,
                clients: clients,
                exportDate: new Date().toISOString(),
                version: '1.0.0',
                exportedBy: currentUser ? currentUser.username : 'Inconnu'
            };
            
            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `FootManager_Export_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            logActivity('Export complet', `${reservations.length} réservations, ${transactions.length} transactions, ${clients.length} clients`);
        }
        
        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const importedData = JSON.parse(text);
                
                // Vérifier la structure des données
                if (!importedData.reservations || !importedData.transactions || !importedData.clients) {
                    alert('❌ Fichier invalide : structure de données incorrecte');
                    return;
                }
                
                const confirmMessage = `📥 Import de données détecté !

📊 Données à importer :
• ${importedData.reservations.length} réservations
• ${importedData.transactions.length} transactions
• ${importedData.clients.length} clients
• Exporté le: ${new Date(importedData.exportDate).toLocaleString('fr-FR')}
• Par: ${importedData.exportedBy || 'Inconnu'}

📱 Vos données actuelles :
• ${reservations.length} réservations
• ${transactions.length} transactions
• ${clients.length} clients

⚠️ Remplacer les données actuelles par celles importées ?`;

                if (confirm(confirmMessage)) {
                    reservations = importedData.reservations;
                    transactions = importedData.transactions;
                    clients = importedData.clients;
                    
                    // Sauvegarder sur GitHub
                    await dataStorage.saveData();
                    githubStorage.markPendingChanges();
                    
                    // Recharger l'affichage
                    updateDataStats();
                    if (currentPage === 'dashboard') loadDashboard();
                    if (currentPage === 'reservations') loadReservations();
                    if (currentPage === 'clients') loadClients();
                    
                    logActivity('Import complet', `${importedData.reservations.length} réservations, ${importedData.transactions.length} transactions, ${importedData.clients.length} clients importés`);
                    alert('✅ Données importées avec succès !');
                }
            } catch (error) {
                console.error('Erreur import:', error);
                alert('❌ Erreur lors de l\'import : fichier corrompu ou format invalide');
            }
            
            // Reset file input
            event.target.value = '';
        }
        
        function exportLocalData() {
            const localData = {
                reservations: reservations,
                transactions: transactions,
                clients: clients,
                credentials: JSON.parse(localStorage.getItem('userCredentials')) || {},
                activityLogs: JSON.parse(localStorage.getItem('activityLogs')) || [],
                exportDate: new Date().toISOString(),
                version: '1.0.0',
                exportType: 'local_complete',
                exportedBy: currentUser ? currentUser.username : 'Inconnu'
            };
            
            const dataStr = JSON.stringify(localData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `FootManager_Local_Export_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            logActivity('Export local complet', 'Toutes les données locales exportées');
        }
        
        async function importLocalData(importedData) {
            try {
                if (importedData.reservations) reservations = importedData.reservations;
                if (importedData.transactions) transactions = importedData.transactions;
                if (importedData.clients) clients = importedData.clients;
                if (importedData.credentials) {
                    localStorage.setItem('userCredentials', JSON.stringify(importedData.credentials));
                }
                if (importedData.activityLogs) {
                    localStorage.setItem('activityLogs', JSON.stringify(importedData.activityLogs));
                }
                
                // Sauvegarder sur GitHub
                await dataStorage.saveData();
                githubStorage.markPendingChanges();
                
                return true;
            } catch (error) {
                console.error('Erreur import local:', error);
                return false;
            }
        }

        // Système de stockage GitHub
        const githubStorage = {
            isEnabled: true, // Toujours activé
            syncInterval: null,
            pendingChanges: 0,
            lastSyncTime: localStorage.getItem('lastGithubSync') || null,
            owner: 'TolojanaharyFrancko',
            repo: 'footmanager-data',
            branch: 'main',
            fileName: 'footmanager-data.json',
            apiUrl: 'https://api.github.com',
            autoCreateRepo: true,
            
            // Initialiser le système GitHub
            init() {
                this.updateGitHubStatus();
                this.updateGitHubStats();
                
                if (this.isEnabled) {
                    this.startAutoSync();
                }
            },
            
            // Obtenir le token GitHub depuis le localStorage ou demander à l'utilisateur
            getGitHubToken() {
                let token = localStorage.getItem('githubToken');
                if (!token) {
                    token = prompt(`🔐 Token GitHub requis pour synchroniser avec ${this.owner}/${this.repo}

Pour créer un token :
1. Allez sur github.com → Settings → Developer settings → Personal access tokens
2. Créez un token avec les permissions "repo"
3. Copiez le token ici

Token GitHub :`);
                    
                    if (token) {
                        localStorage.setItem('githubToken', token);
                        this.showGitHubNotification('✅ Token GitHub configuré');
                    }
                }
                return token;
            },

            // Pousser les données vers GitHub (avec authentification réelle)
            async pushToGitHub() {
                try {
                    const token = this.getGitHubToken();
                    if (!token) {
                        this.showGitHubNotification('❌ Token GitHub requis');
                        return false;
                    }

                    const data = {
                        reservations: reservations,
                        transactions: transactions,
                        clients: clients,
                        lastModified: new Date().toISOString(),
                        version: Date.now(),
                        savedBy: currentUser ? currentUser.username : 'Système',
                        appVersion: '1.0.0'
                    };
                    
                    // Vérifier si le repository existe
                    const repoExists = await this.checkRepositoryExists(token);
                    if (!repoExists) {
                        const created = await this.createRepository(token);
                        if (!created) {
                            this.showGitHubNotification('❌ Impossible de créer le repository');
                            return false;
                        }
                    }

                    // Obtenir le SHA du fichier existant (si il existe)
                    let fileSha = null;
                    try {
                        const fileResponse = await fetch(`${this.apiUrl}/repos/${this.owner}/${this.repo}/contents/${this.fileName}`, {
                            headers: {
                                'Authorization': `token ${token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        });
                        
                        if (fileResponse.ok) {
                            const fileData = await fileResponse.json();
                            fileSha = fileData.sha;
                        }
                    } catch (error) {
                        console.log('Fichier n\'existe pas encore, création...');
                    }

                    // Encoder les données en base64
                    const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
                    
                    // Créer ou mettre à jour le fichier
                    const commitMessage = `🔄 Mise à jour FootManager - ${new Date().toLocaleString('fr-FR')}`;
                    
                    const updateData = {
                        message: commitMessage,
                        content: content,
                        branch: this.branch
                    };
                    
                    if (fileSha) {
                        updateData.sha = fileSha;
                    }

                    const response = await fetch(`${this.apiUrl}/repos/${this.owner}/${this.repo}/contents/${this.fileName}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updateData)
                    });

                    if (response.ok) {
                        this.lastSyncTime = new Date().toISOString();
                        localStorage.setItem('lastGithubSync', this.lastSyncTime);
                        this.pendingChanges = 0;
                        
                        this.updateGitHubStatus();
                        this.updateGitHubStats();
                        
                        this.showGitHubNotification(`✅ Données sauvegardées sur GitHub/${this.owner}/${this.repo}`);
                        logActivity('Push GitHub', `Repository ${this.repo} mis à jour avec succès`);
                        
                        return true;
                    } else {
                        const errorData = await response.json();
                        console.error('Erreur GitHub API:', errorData);
                        this.showGitHubNotification(`❌ Erreur GitHub: ${errorData.message}`);
                        return false;
                    }
                } catch (error) {
                    console.error('Erreur push GitHub:', error);
                    this.showGitHubNotification('❌ Erreur de connexion GitHub');
                    return false;
                }
            },

            // Vérifier si le repository existe
            async checkRepositoryExists(token) {
                try {
                    const response = await fetch(`${this.apiUrl}/repos/${this.owner}/${this.repo}`, {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    return response.ok;
                } catch (error) {
                    return false;
                }
            },

            // Créer le repository automatiquement
            async createRepository(token) {
                try {
                    const repoData = {
                        name: this.repo,
                        description: 'Données FootManager Pro - Gestion de terrain de football',
                        private: false,
                        auto_init: true
                    };

                    const response = await fetch(`${this.apiUrl}/user/repos`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(repoData)
                    });

                    if (response.ok) {
                        this.showGitHubNotification(`✅ Repository ${this.repo} créé automatiquement`);
                        logActivity('Création repository', `Repository ${this.repo} créé sur GitHub`);
                        return true;
                    } else {
                        const errorData = await response.json();
                        console.error('Erreur création repository:', errorData);
                        return false;
                    }
                } catch (error) {
                    console.error('Erreur création repository:', error);
                    return false;
                }
            },
            
            // Récupérer les données depuis GitHub (authentification réelle)
            async pullFromGitHub() {
                try {
                    const token = this.getGitHubToken();
                    if (!token) {
                        this.showGitHubNotification('❌ Token GitHub requis');
                        return false;
                    }

                    // Récupérer le fichier depuis GitHub
                    const response = await fetch(`${this.apiUrl}/repos/${this.owner}/${this.repo}/contents/${this.fileName}`, {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (!response.ok) {
                        if (response.status === 404) {
                            this.showGitHubNotification('❌ Aucune sauvegarde trouvée sur GitHub');
                        } else {
                            const errorData = await response.json();
                            this.showGitHubNotification(`❌ Erreur GitHub: ${errorData.message}`);
                        }
                        return false;
                    }

                    const fileData = await response.json();
                    
                    // Décoder le contenu base64
                    const decodedContent = decodeURIComponent(escape(atob(fileData.content)));
                    const data = JSON.parse(decodedContent);
                    
                    // Vérifier s'il y a des données existantes
                    const hasLocalData = reservations.length > 0 || transactions.length > 0 || clients.length > 0;
                    
                    if (hasLocalData) {
                        const confirmMessage = `🔄 Données GitHub détectées !

📊 Repository: ${this.owner}/${this.repo}
• ${data.reservations?.length || 0} réservations
• ${data.transactions?.length || 0} transactions  
• ${data.clients?.length || 0} clients
• Sauvegardé le: ${new Date(data.lastModified).toLocaleString('fr-FR')}
• Par: ${data.savedBy}
• Version: ${data.appVersion || 'Inconnue'}

📱 Vos données actuelles :
• ${reservations.length} réservations
• ${transactions.length} transactions
• ${clients.length} clients

⚠️ Remplacer les données actuelles par celles de GitHub ?`;

                        if (!confirm(confirmMessage)) {
                            return false;
                        }
                    }
                    
                    // Charger les données depuis GitHub
                    reservations = data.reservations || [];
                    transactions = data.transactions || [];
                    clients = data.clients || [];
                    
                    this.lastSyncTime = new Date().toISOString();
                    localStorage.setItem('lastGithubSync', this.lastSyncTime);
                    this.pendingChanges = 0;
                    
                    this.updateGitHubStatus();
                    this.updateGitHubStats();
                    
                    this.showGitHubNotification(`✅ Données récupérées depuis ${this.owner}/${this.repo}`);
                    logActivity('Pull GitHub', `Données chargées depuis repository ${this.repo}`);
                    
                    // Recharger l'affichage
                    if (currentPage === 'dashboard') loadDashboard();
                    if (currentPage === 'reservations') loadReservations();
                    if (currentPage === 'clients') loadClients();
                    if (currentPage === 'administration') updateDataStats();
                    
                    return true;
                } catch (error) {
                    console.error('Erreur pull GitHub:', error);
                    this.showGitHubNotification('❌ Erreur de connexion GitHub');
                    return false;
                }
            },
            
            // Activer/désactiver la synchronisation automatique
            toggleAutoSync() {
                this.isEnabled = !this.isEnabled;
                localStorage.setItem('githubAutoSync', this.isEnabled.toString());
                
                if (this.isEnabled) {
                    this.startAutoSync();
                    this.showGitHubNotification('🔄 Synchronisation GitHub activée');
                } else {
                    this.stopAutoSync();
                    this.showGitHubNotification('⏸️ Synchronisation GitHub désactivée');
                }
                
                this.updateGitHubStatus();
                this.updateGitHubStats();
                logActivity('Toggle sync GitHub', this.isEnabled ? 'Activé' : 'Désactivé');
            },
            
            // Démarrer la synchronisation automatique
            startAutoSync() {
                if (this.syncInterval) {
                    clearInterval(this.syncInterval);
                }
                
                // Synchroniser toutes les 30 secondes
                this.syncInterval = setInterval(async () => {
                    if (this.pendingChanges > 0) {
                        await this.pushToGitHub();
                    }
                }, 30000); // 30 secondes
            },
            
            // Arrêter la synchronisation automatique
            stopAutoSync() {
                if (this.syncInterval) {
                    clearInterval(this.syncInterval);
                    this.syncInterval = null;
                }
            },
            
            // Marquer des modifications en attente
            markPendingChanges() {
                this.pendingChanges++;
                this.updateGitHubStats();
            },
            
            // Mettre à jour le statut GitHub
            updateGitHubStatus() {
                const statusElement = document.getElementById('githubStatus');
                if (!statusElement) return;
                
                const dot = statusElement.querySelector('div');
                const text = statusElement.querySelector('span');
                
                if (this.isEnabled) {
                    dot.className = 'w-2 h-2 bg-green-500 rounded-full';
                    text.textContent = 'Sync activée';
                    text.className = 'text-sm text-green-600';
                } else {
                    dot.className = 'w-2 h-2 bg-gray-400 rounded-full';
                    text.textContent = 'Sync désactivée';
                    text.className = 'text-sm text-gray-600';
                }
            },
            
            // Mettre à jour les statistiques GitHub
            updateGitHubStats() {
                const pendingElement = document.getElementById('githubPendingChanges');
                const lastSyncElement = document.getElementById('githubLastSync');
                const autoSyncTextElement = document.getElementById('githubAutoSyncText');
                
                if (pendingElement) {
                    pendingElement.textContent = this.pendingChanges;
                }
                
                if (lastSyncElement && this.lastSyncTime) {
                    const lastSync = new Date(this.lastSyncTime);
                    lastSyncElement.textContent = lastSync.toLocaleString('fr-FR');
                } else if (lastSyncElement) {
                    lastSyncElement.textContent = 'Jamais';
                }
                
                if (autoSyncTextElement) {
                    autoSyncTextElement.textContent = this.isEnabled ? 'Désactiver sync auto' : 'Activer sync auto';
                }
            },
            
            // Réinitialiser le token GitHub
            resetGitHubToken() {
                localStorage.removeItem('githubToken');
                this.showGitHubNotification('🔄 Token GitHub supprimé - Nouveau token requis');
            },

            // Tester la connexion GitHub
            async testGitHubConnection() {
                try {
                    const token = this.getGitHubToken();
                    if (!token) return false;

                    const response = await fetch(`${this.apiUrl}/user`, {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (response.ok) {
                        const userData = await response.json();
                        this.showGitHubNotification(`✅ Connecté à GitHub en tant que ${userData.login}`);
                        return true;
                    } else {
                        this.showGitHubNotification('❌ Token GitHub invalide');
                        this.resetGitHubToken();
                        return false;
                    }
                } catch (error) {
                    this.showGitHubNotification('❌ Erreur de connexion GitHub');
                    return false;
                }
            },

            // Afficher une notification GitHub
            showGitHubNotification(message) {
                const notification = document.createElement('div');
                notification.className = 'fixed top-4 right-4 bg-white border border-gray-200 rounded-lg shadow-lg p-3 z-50 animate-fade-in';
                notification.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <i class="fab fa-github text-gray-800"></i>
                        <span class="text-sm font-medium text-gray-800">${message}</span>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }
        };

        // Système de base de données GitHub uniquement
        const dataStorage = {
            // Sauvegarder toutes les données directement sur GitHub
            async saveData() {
                await githubStorage.pushToGitHub();
            },
            
            // Charger toutes les données depuis GitHub
            async loadData() {
                await githubStorage.pullFromGitHub();
            },
            
            // Exporter toutes les données
            exportAllData() {
                return {
                    reservations: reservations,
                    transactions: transactions,
                    clients: clients,
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };
            },
            
            // Importer des données
            async importData(data) {
                try {
                    if (data.reservations) reservations = data.reservations;
                    if (data.transactions) transactions = data.transactions;
                    if (data.clients) clients = data.clients;
                    
                    await this.saveData();
                    return true;
                } catch (error) {
                    console.error('Erreur import:', error);
                    return false;
                }
            },
            
            // Réinitialiser toutes les données
            async resetAllData() {
                reservations = [];
                transactions = [];
                clients = [];
                
                await this.saveData();
            },
            
            // Obtenir les statistiques de stockage
            getStorageStats() {
                const reservationsSize = JSON.stringify(reservations).length;
                const transactionsSize = JSON.stringify(transactions).length;
                const clientsSize = JSON.stringify(clients).length;
                const totalSize = reservationsSize + transactionsSize + clientsSize;
                
                return {
                    reservationsCount: reservations.length,
                    transactionsCount: transactions.length,
                    clientsCount: clients.length,
                    totalSizeKB: (totalSize / 1024).toFixed(1),
                    lastModified: githubStorage.lastSyncTime
                };
            }
        };



        // Initialize app
        document.addEventListener('DOMContentLoaded', async function() {
            updateCurrentDate();
            initializeSampleData();
            
            // Initialiser le système de stockage GitHub uniquement
            githubStorage.init();
            updateGitStatusHeader();
            
            // Charger automatiquement les données depuis GitHub au démarrage
            await githubStorage.pullFromGitHub();
        });

        function updateCurrentDate() {
            const now = new Date();
            document.getElementById('currentDate').textContent = now.toLocaleDateString('fr-FR', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // Set today's date in date inputs
            const today = now.toISOString().split('T')[0];
            document.getElementById('reservationDate').value = today;
            document.getElementById('historyStartDate').value = today;
            document.getElementById('historyEndDate').value = today;
        }

        function initializeSampleData() {
            // L'application démarre maintenant avec une base de données complètement vierge
            // Aucune donnée d'exemple n'est ajoutée automatiquement
            // Les tableaux restent vides jusqu'à ce que l'utilisateur ajoute des données
        }

        function login(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const role = document.getElementById('role').value;

            // Récupérer les identifiants stockés
            const storedCredentials = JSON.parse(localStorage.getItem('userCredentials')) || {
                proprietaire: { username: 'admin', password: 'admin' },
                receptionniste: { username: 'user', password: 'user' }
            };

            // Authentification selon le rôle
            let isValid = false;
            let errorMessage = '';

            if (role === 'proprietaire') {
                if (username === storedCredentials.proprietaire.username && password === storedCredentials.proprietaire.password) {
                    isValid = true;
                } else {
                    errorMessage = `Identifiants incorrects pour le propriétaire.<br>Utilisez : <strong>${storedCredentials.proprietaire.username}</strong> / <strong>${storedCredentials.proprietaire.password}</strong>`;
                }
            } else if (role === 'receptionniste') {
                if (username === storedCredentials.receptionniste.username && password === storedCredentials.receptionniste.password) {
                    isValid = true;
                } else {
                    errorMessage = `Identifiants incorrects pour le réceptionniste.<br>Utilisez : <strong>${storedCredentials.receptionniste.username}</strong> / <strong>${storedCredentials.receptionniste.password}</strong>`;
                }
            }

            if (isValid) {
                currentUser = { username, role };
                document.getElementById('userInfo').textContent = `${username} (${role})`;
                
                // Show/hide menu items based on role
                if (role === 'proprietaire') {
                    document.getElementById('statsLink').classList.remove('hidden');
                    document.getElementById('databaseLink').classList.remove('hidden');
                    document.getElementById('adminLink').classList.remove('hidden');
                } else {
                    // Hide admin features for receptionniste
                    document.getElementById('statsLink').classList.add('hidden');
                    document.getElementById('databaseLink').classList.add('hidden');
                    document.getElementById('adminLink').classList.add('hidden');
                }
                
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                showPage('dashboard');
            } else {
                showErrorModal(errorMessage);
            }
        }

        function showErrorModal(message) {
            document.getElementById('errorMessage').innerHTML = message;
            document.getElementById('errorModal').classList.remove('hidden');
            document.getElementById('errorModal').classList.add('flex');
        }

        function closeErrorModal() {
            document.getElementById('errorModal').classList.add('hidden');
            document.getElementById('errorModal').classList.remove('flex');
        }

        function logout() {
            currentUser = null;
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('statsLink').classList.add('hidden');
            document.getElementById('databaseLink').classList.add('hidden');
            document.getElementById('adminLink').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function showPage(page) {
            // Hide all pages
            const pages = ['dashboard', 'reservations', 'caisse', 'historique', 'clients', 'statistiques', 'database', 'administration'];
            pages.forEach(p => {
                document.getElementById(p + 'Page').classList.add('hidden');
            });

            // Show selected page
            document.getElementById(page + 'Page').classList.remove('hidden');
            currentPage = page;

            // Update page title
            const titles = {
                dashboard: 'Tableau de bord',
                reservations: 'Réservations',
                caisse: 'Gestion de caisse',
                historique: 'Historique',
                clients: 'Gestion des clients',
                statistiques: 'Statistiques',
                database: 'Base de Données',
                administration: 'Administration'
            };
            document.getElementById('pageTitle').textContent = titles[page];

            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('bg-blue-50', 'text-blue-600');
            });
            event.target.classList.add('bg-blue-50', 'text-blue-600');

            // Load page-specific content
            switch(page) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'reservations':
                    loadReservations();
                    break;
                case 'caisse':
                    loadCaisse();
                    break;
                case 'historique':
                    loadHistorique();
                    break;
                case 'clients':
                    loadClients();
                    break;
                case 'statistiques':
                    loadStatistiques();
                    break;
                case 'database':
                    loadDatabase();
                    break;
                case 'administration':
                    loadAdministration();
                    break;
            }
        }

        function loadDashboard() {
            const today = new Date().toISOString().split('T')[0];
            const todayReservations = reservations.filter(r => r.date === today);
            const todayTransactions = transactions.filter(t => t.date === today);
            
            // Update stats
            document.getElementById('todayReservations').textContent = todayReservations.length;
            
            const todayRevenue = todayTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            document.getElementById('todayRevenue').textContent = todayRevenue.toLocaleString('fr-FR') + ' Ar';
            
            const todayExpenses = todayTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            document.getElementById('todayExpenses').textContent = todayExpenses.toLocaleString('fr-FR') + ' Ar';
            
            const totalRevenue = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            document.getElementById('cashBalance').textContent = (totalRevenue - totalExpenses).toLocaleString('fr-FR') + ' Ar';

            // Load today's slots
            loadTodaySlots();
            loadRecentActivity();
        }

        function loadTodaySlots() {
            const slots = generateTimeSlots();
            const today = new Date().toISOString().split('T')[0];
            const todayReservations = reservations.filter(r => r.date === today);
            
            const slotsHtml = slots.map(slot => {
                const reservation = todayReservations.find(r => r.time === slot);
                let status = 'Libre';
                let statusClass = 'bg-green-100 text-green-800';
                
                if (reservation) {
                    if (reservation.paid) {
                        status = 'Payé';
                        statusClass = 'bg-blue-100 text-blue-800';
                    } else {
                        status = 'Réservé';
                        statusClass = 'bg-yellow-100 text-yellow-800';
                    }
                }
                
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <span class="font-medium text-gray-800">${slot}</span>
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">${status}</span>
                    </div>
                `;
            }).join('');
            
            document.getElementById('todaySlots').innerHTML = slotsHtml;
        }

        function loadRecentActivity() {
            const recentTransactions = transactions
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);
            
            const activityHtml = recentTransactions.map(transaction => {
                const icon = transaction.type === 'income' ? 'fa-plus-circle text-green-500' : 'fa-minus-circle text-red-500';
                const sign = transaction.type === 'income' ? '+' : '-';
                
                return `
                    <div class="flex items-center space-x-3">
                        <i class="fas ${icon}"></i>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-800">${transaction.description}</p>
                            <p class="text-xs text-gray-500">${new Date(transaction.date).toLocaleDateString('fr-FR')}</p>
                        </div>
                        <span class="text-sm font-semibold ${transaction.type === 'income' ? 'text-green-600' : 'text-red-600'}">
                            ${sign}${transaction.amount.toLocaleString('fr-FR')} Ar
                        </span>
                    </div>
                `;
            }).join('');
            
            document.getElementById('recentActivity').innerHTML = activityHtml;
        }

        function loadReservations() {
            const slots = generateTimeSlots();
            const selectedDate = document.getElementById('reservationDate').value;
            const statusFilter = document.getElementById('slotStatusFilter').value;
            const dateReservations = reservations.filter(r => r.date === selectedDate);
            
            const filteredSlots = slots.filter(slot => {
                const reservation = dateReservations.find(r => r.time === slot);
                
                switch (statusFilter) {
                    case 'free':
                        return !reservation;
                    case 'reserved':
                        return reservation && !reservation.paid;
                    case 'paid':
                        return reservation && reservation.paid;
                    case 'all':
                    default:
                        return true;
                }
            });
            
            const slotsHtml = filteredSlots.map(slot => {
                const reservation = dateReservations.find(r => r.time === slot);
                let slotClass = 'slot-free';
                let buttonText = 'Réserver';
                let buttonAction = `openReservationModal('${slot}')`;
                let clientInfo = '';
                
                if (reservation) {
                    if (reservation.paid) {
                        slotClass = 'slot-paid';
                        buttonText = 'Payé';
                        buttonAction = `viewReservation(${reservation.id})`;
                        clientInfo = `<p class="text-white text-sm mt-1">${reservation.client}</p>`;
                        if (reservation.isConsecutive) {
                            clientInfo += `<p class="text-white text-xs opacity-75">${reservation.slotNumber}/${reservation.totalSlots}</p>`;
                        }
                    } else {
                        slotClass = 'slot-reserved';
                        buttonText = 'Réservé';
                        buttonAction = `viewReservation(${reservation.id})`;
                        clientInfo = `<p class="text-white text-sm mt-1">${reservation.client}</p>`;
                        if (reservation.isConsecutive) {
                            clientInfo += `<p class="text-white text-xs opacity-75">${reservation.slotNumber}/${reservation.totalSlots}</p>`;
                        }
                    }
                }
                
                return `
                    <div id="slot-${slot.replace(/[:-]/g, '')}" class="${slotClass} rounded-xl p-4 text-white card-hover cursor-pointer transform transition-all duration-100 hover:scale-105" onclick="${buttonAction}">
                        <div class="flex items-center justify-between">
                            <h4 class="font-semibold">${slot}</h4>
                            <i class="fas fa-futbol transition-transform duration-100 hover:rotate-12"></i>
                        </div>
                        ${clientInfo}
                        <div class="mt-3">
                            <span class="text-sm opacity-90 transition-opacity duration-100 hover:opacity-100">${buttonText}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('timeSlots').innerHTML = slotsHtml;
        }

        function generateTimeSlots() {
            const slots = [];
            // Créneaux de 30 minutes de 8h00 à 22h00
            for (let hour = 8; hour < 22; hour++) {
                for (let min = 0; min < 60; min += 30) {
                    const startHour = hour;
                    const startMin = min;
                    const endMin = min + 30;
                    const endHour = endMin >= 60 ? hour + 1 : hour;
                    const finalEndMin = endMin >= 60 ? 0 : endMin;
                    
                    const startTime = `${startHour.toString().padStart(2, '0')}:${startMin.toString().padStart(2, '0')}`;
                    const endTime = `${endHour.toString().padStart(2, '0')}:${finalEndMin.toString().padStart(2, '0')}`;
                    
                    slots.push(`${startTime}-${endTime}`);
                }
            }
            return slots;
        }

        function openReservationModal(slot) {
            currentSlot = slot;
            document.getElementById('modalSlot').value = slot;
            document.getElementById('consecutiveSlots').value = '1';
            updateReservationAmount(); // Calculer le montant initial
            document.getElementById('reservationModal').classList.remove('hidden');
            document.getElementById('reservationModal').classList.add('flex');
        }

        function closeModal() {
            document.getElementById('reservationModal').classList.add('hidden');
            document.getElementById('reservationModal').classList.remove('flex');
            // Reset form
            document.getElementById('clientName').value = '';
            document.getElementById('clientPhone').value = '';
            document.getElementById('existingClient').value = '';
            document.getElementById('consecutiveSlots').value = '1';
            document.getElementById('isPaid').checked = false;
            updateReservationAmount(); // Recalculer le montant par défaut
        }

        function updateReservationAmount() {
            const slots = parseInt(document.getElementById('consecutiveSlots').value);
            const totalAmount = slots * slotPrice;
            document.getElementById('reservationAmount').value = totalAmount;
            document.getElementById('priceInfo').textContent = `${slotPrice.toLocaleString('fr-FR')} Ar par créneau × ${slots} créneau${slots > 1 ? 'x' : ''} = ${totalAmount.toLocaleString('fr-FR')} Ar`;
        }

        async function updateSlotPrice(event) {
            event.preventDefault();
            
            const newPrice = parseInt(document.getElementById('slotPriceInput').value);
            if (newPrice && newPrice >= 1000) {
                slotPrice = newPrice;
                localStorage.setItem('slotPrice', slotPrice.toString());
                
                // Mettre à jour l'affichage
                document.getElementById('currentSlotPrice').textContent = slotPrice.toLocaleString('fr-FR') + ' Ar';
                
                // Mettre à jour le montant de réservation si le modal est ouvert
                if (document.getElementById('reservationModal').classList.contains('flex')) {
                    updateReservationAmount();
                }
                
                // Sauvegarder sur GitHub
                await dataStorage.saveData();
                githubStorage.markPendingChanges();
                
                logActivity('Modification prix créneau', `Nouveau prix: ${slotPrice.toLocaleString('fr-FR')} Ar`);
                alert(`✅ Prix mis à jour: ${slotPrice.toLocaleString('fr-FR')} Ar par créneau`);
            } else {
                alert('❌ Veuillez saisir un prix valide (minimum 1000 Ar)');
            }
        }

        async function saveReservation(event) {
            event.preventDefault();
            
            const reservation = {
                id: Date.now(),
                date: document.getElementById('reservationDate').value,
                time: currentSlot,
                client: document.getElementById('clientName').value,
                phone: document.getElementById('clientPhone').value,
                amount: parseFloat(document.getElementById('reservationAmount').value),
                paid: document.getElementById('isPaid').checked
            };
            
            reservations.push(reservation);
            
            // Add transaction if paid
            if (reservation.paid) {
                const transaction = {
                    id: Date.now(),
                    date: reservation.date,
                    type: 'income',
                    description: `Réservation ${reservation.client}`,
                    amount: reservation.amount,
                    category: 'reservation'
                };
                transactions.push(transaction);
            }
            
            // Sauvegarder sur GitHub
            await dataStorage.saveData();
            githubStorage.markPendingChanges();
            
            // Synchronisation immédiate si auto-sync activé
            if (githubStorage.isEnabled) {
                setTimeout(() => {
                    githubStorage.pushToGitHub();
                }, 500); // Synchronisation ultra-rapide
            }
            
            closeModal();
            
            // Mise à jour instantanée des créneaux nouvellement réservés
            for (let i = 0; i < consecutiveSlots; i++) {
                const slotTime = allSlots[startSlotIndex + i];
                updateNewReservationSlot(slotTime, document.getElementById('clientName').value, document.getElementById('isPaid').checked);
            }
            
            // Recharger complètement après une courte pause
            setTimeout(() => {
                loadReservations();
                if (currentPage === 'dashboard') loadDashboard();
            }, 100);
        }

        async function viewReservation(id) {
            const reservation = reservations.find(r => r.id === id);
            if (reservation) {
                let message = `Client: ${reservation.client}\nTéléphone: ${reservation.phone}\nCréneau: ${reservation.time}\n`;
                
                if (reservation.isConsecutive) {
                    const groupReservations = reservations.filter(r => r.consecutiveGroup === reservation.consecutiveGroup);
                    const totalAmount = groupReservations.reduce((sum, r) => sum + r.amount, 0);
                    message += `Réservation: ${reservation.slotNumber}/${reservation.totalSlots} créneaux consécutifs\nMontant total: ${totalAmount}€\n`;
                } else {
                    message += `Montant: ${reservation.amount}€\n`;
                }
                
                message += `Statut: ${reservation.paid ? 'Payé' : 'Réservé'}\n\n`;
                
                const action = reservation.paid ? 'Annuler' : 'Marquer comme payé';
                const actionText = reservation.isConsecutive ? 
                    `${action.toLowerCase()} tous les créneaux de cette réservation` : 
                    `${action.toLowerCase()} cette réservation`;
                
                if (confirm(message + `Voulez-vous ${actionText}?`)) {
                    if (reservation.paid) {
                        // Cancel reservation(s)
                        if (reservation.isConsecutive) {
                            // Remove all consecutive reservations
                            const groupId = reservation.consecutiveGroup;
                            reservations = reservations.filter(r => r.consecutiveGroup !== groupId);
                            transactions = transactions.filter(t => t.id !== groupId);
                        } else {
                            reservations = reservations.filter(r => r.id !== id);
                            transactions = transactions.filter(t => !t.description.includes(reservation.client));
                        }
                    } else {
                        // Mark as paid
                        if (reservation.isConsecutive) {
                            // Mark all consecutive reservations as paid
                            const groupReservations = reservations.filter(r => r.consecutiveGroup === reservation.consecutiveGroup);
                            const totalAmount = groupReservations.reduce((sum, r) => sum + r.amount, 0);
                            
                            groupReservations.forEach(r => r.paid = true);
                            
                            const transaction = {
                                id: reservation.consecutiveGroup,
                                date: reservation.date,
                                type: 'income',
                                description: `Réservation ${reservation.client} (${reservation.totalSlots} créneaux)`,
                                amount: totalAmount,
                                category: 'reservation'
                            };
                            transactions.push(transaction);
                        } else {
                            reservation.paid = true;
                            const transaction = {
                                id: Date.now(),
                                date: reservation.date,
                                type: 'income',
                                description: `Réservation ${reservation.client}`,
                                amount: reservation.amount,
                                category: 'reservation'
                            };
                            transactions.push(transaction);
                        }
                    }
                    
                    // Sauvegarder sur GitHub
                    await dataStorage.saveData();
                    githubStorage.markPendingChanges();
                    
                    // Synchronisation immédiate si auto-sync activé
                    if (githubStorage.isEnabled) {
                        setTimeout(() => {
                            githubStorage.pushToGitHub();
                        }, 500); // Synchronisation ultra-rapide en 0.5 seconde
                    }
                    
                    // Mise à jour instantanée de l'affichage avec animation
                    updateSlotStatusInstantly(reservation);
                    
                    // Recharger complètement après une courte pause pour s'assurer de la cohérence
                    setTimeout(() => {
                        loadReservations();
                        if (currentPage === 'dashboard') loadDashboard();
                    }, 100);
                    
                    // Log de l'activité
                    logActivity(reservation.paid ? 'Annulation réservation' : 'Paiement réservation', 
                        `${reservation.client} - ${reservation.time} - ${reservation.amount}€`);
                }
            }
        }

        function loadCaisse() {
            const transactionsHtml = transactions
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 20)
                .map(transaction => {
                    const typeClass = transaction.type === 'income' ? 'text-green-600' : 'text-red-600';
                    const typeIcon = transaction.type === 'income' ? 'fa-plus-circle' : 'fa-minus-circle';
                    const sign = transaction.type === 'income' ? '+' : '-';
                    
                    return `
                        <tr class="border-b border-gray-100">
                            <td class="py-3 px-4 text-sm text-gray-600">${new Date(transaction.date).toLocaleDateString('fr-FR')}</td>
                            <td class="py-3 px-4">
                                <span class="flex items-center space-x-2">
                                    <i class="fas ${typeIcon} ${typeClass}"></i>
                                    <span class="text-sm font-medium ${typeClass}">${transaction.type === 'income' ? 'Recette' : 'Dépense'}</span>
                                </span>
                            </td>
                            <td class="py-3 px-4 text-sm text-gray-800">${transaction.description}</td>
                            <td class="py-3 px-4 text-right text-sm font-semibold ${typeClass}">${sign}${transaction.amount.toLocaleString('fr-FR')} Ar</td>
                        </tr>
                    `;
                }).join('');
            
            document.getElementById('transactionsList').innerHTML = transactionsHtml;
        }

        async function addExpense(event) {
            event.preventDefault();
            
            const expense = {
                id: Date.now(),
                date: new Date().toISOString().split('T')[0],
                type: 'expense',
                description: document.getElementById('expenseDescription').value,
                amount: parseFloat(document.getElementById('expenseAmount').value),
                category: document.getElementById('expenseCategory').value
            };
            
            transactions.push(expense);
            
            // Sauvegarder sur GitHub
            await dataStorage.saveData();
            githubStorage.markPendingChanges();
            
            // Synchronisation immédiate si auto-sync activé
            if (githubStorage.isEnabled) {
                setTimeout(() => {
                    githubStorage.pushToGitHub();
                }, 1000);
            }
            
            // Reset form
            document.getElementById('expenseDescription').value = '';
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseCategory').value = 'maintenance';
            
            loadCaisse();
            if (currentPage === 'dashboard') loadDashboard();
        }

        function loadHistorique() {
            const startDate = document.getElementById('historyStartDate').value;
            const endDate = document.getElementById('historyEndDate').value;
            const filter = document.getElementById('historyFilter').value;
            
            let filteredData = [];
            
            // Add reservations to history
            if (filter === 'all' || filter === 'reservations') {
                reservations.forEach(reservation => {
                    if (reservation.date >= startDate && reservation.date <= endDate) {
                        filteredData.push({
                            id: `reservation_${reservation.id}`,
                            date: reservation.date,
                            type: 'Réservation',
                            client: reservation.client,
                            slot: reservation.time,
                            amount: reservation.amount,
                            status: reservation.paid ? 'Payé' : 'Réservé',
                            category: 'reservation',
                            originalType: 'reservation',
                            originalId: reservation.id
                        });
                    }
                });
            }
            
            // Add transactions to history
            if (filter === 'all' || filter === 'income' || filter === 'expenses') {
                transactions.forEach(transaction => {
                    if (transaction.date >= startDate && transaction.date <= endDate) {
                        if (filter === 'all' || 
                            (filter === 'income' && transaction.type === 'income') ||
                            (filter === 'expenses' && transaction.type === 'expense')) {
                            filteredData.push({
                                id: `transaction_${transaction.id}`,
                                date: transaction.date,
                                type: transaction.type === 'income' ? 'Recette' : 'Dépense',
                                client: transaction.description,
                                slot: '-',
                                amount: transaction.amount,
                                status: transaction.type === 'income' ? 'Encaissé' : 'Payé',
                                category: transaction.category,
                                originalType: 'transaction',
                                originalId: transaction.id
                            });
                        }
                    }
                });
            }
            
            // Sort by date
            filteredData.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const categoryColors = {
                'reservation': 'bg-blue-100 text-blue-800',
                'maintenance': 'bg-orange-100 text-orange-800',
                'equipement': 'bg-purple-100 text-purple-800',
                'utilities': 'bg-yellow-100 text-yellow-800',
                'other': 'bg-gray-100 text-gray-800'
            };
            
            const categoryNames = {
                'reservation': 'Réservation',
                'maintenance': 'Maintenance',
                'equipement': 'Équipement',
                'utilities': 'Factures',
                'other': 'Autre'
            };
            
            const historyHtml = filteredData.map(item => {
                const statusClass = item.status === 'Payé' || item.status === 'Encaissé' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                const amountClass = item.type === 'Dépense' ? 'text-red-600' : 'text-green-600';
                const sign = item.type === 'Dépense' ? '-' : '+';
                
                const categoryClass = categoryColors[item.category] || 'bg-gray-100 text-gray-800';
                const categoryName = categoryNames[item.category] || 'Non défini';
                
                return `
                    <tr class="border-b border-gray-100">
                        <td class="py-3 px-2 text-center">
                            <input type="checkbox" class="history-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500" data-id="${item.id}">
                        </td>
                        <td class="py-3 px-4 text-sm text-gray-600">${new Date(item.date).toLocaleDateString('fr-FR')}</td>
                        <td class="py-3 px-4">
                            <div class="flex items-center space-x-2">
                                <span class="text-sm font-medium text-gray-800">${item.type}</span>
                                <span class="px-2 py-1 text-xs font-medium rounded-full ${categoryClass}">${categoryName}</span>
                            </div>
                        </td>
                        <td class="py-3 px-4 text-sm text-gray-800">${item.client}</td>
                        <td class="py-3 px-4 text-sm text-gray-600">${item.slot}</td>
                        <td class="py-3 px-4 text-right text-sm font-semibold ${amountClass}">${sign}${item.amount.toLocaleString('fr-FR')} Ar</td>
                        <td class="py-3 px-4 text-center">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">${item.status}</span>
                        </td>
                        <td class="py-3 px-4 text-center">
                            <button onclick="deleteHistoryItem('${item.id}')" class="text-red-600 hover:text-red-800 transition-colors">
                                <i class="fas fa-trash text-sm"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('historyList').innerHTML = historyHtml;
        }

        function exportHistory() {
            const startDate = document.getElementById('historyStartDate').value;
            const endDate = document.getElementById('historyEndDate').value;
            const filter = document.getElementById('historyFilter').value;
            
            let filteredData = [];
            
            // Collecter les données selon le filtre
            if (filter === 'all' || filter === 'reservations') {
                reservations.forEach(reservation => {
                    if (reservation.date >= startDate && reservation.date <= endDate) {
                        filteredData.push({
                            Date: new Date(reservation.date).toLocaleDateString('fr-FR'),
                            Type: 'Réservation',
                            'Client/Description': reservation.client,
                            'Téléphone': reservation.phone,
                            'Créneau': reservation.time,
                            'Montant': reservation.amount,
                            'Statut': reservation.paid ? 'Payé' : 'Réservé',
                            'Catégorie': 'Réservation'
                        });
                    }
                });
            }
            
            if (filter === 'all' || filter === 'income' || filter === 'expenses') {
                transactions.forEach(transaction => {
                    if (transaction.date >= startDate && transaction.date <= endDate) {
                        if (filter === 'all' || 
                            (filter === 'income' && transaction.type === 'income') ||
                            (filter === 'expenses' && transaction.type === 'expense')) {
                            
                            const categoryNames = {
                                'reservation': 'Réservation',
                                'maintenance': 'Maintenance',
                                'equipement': 'Équipement',
                                'utilities': 'Factures',
                                'other': 'Autre'
                            };
                            
                            filteredData.push({
                                Date: new Date(transaction.date).toLocaleDateString('fr-FR'),
                                Type: transaction.type === 'income' ? 'Recette' : 'Dépense',
                                'Client/Description': transaction.description,
                                'Téléphone': '-',
                                'Créneau': '-',
                                'Montant': transaction.amount,
                                'Statut': transaction.type === 'income' ? 'Encaissé' : 'Payé',
                                'Catégorie': categoryNames[transaction.category] || 'Non défini'
                            });
                        }
                    }
                });
            }
            
            // Trier par date
            filteredData.sort((a, b) => new Date(b.Date.split('/').reverse().join('-')) - new Date(a.Date.split('/').reverse().join('-')));
            
            // Calculer les totaux
            const totalRecettes = filteredData.filter(item => item.Type === 'Recette' || item.Type === 'Réservation').reduce((sum, item) => sum + item.Montant, 0);
            const totalDepenses = filteredData.filter(item => item.Type === 'Dépense').reduce((sum, item) => sum + item.Montant, 0);
            const solde = totalRecettes - totalDepenses;
            
            // Ajouter ligne de totaux
            filteredData.push({
                Date: '',
                Type: 'TOTAUX',
                'Client/Description': '',
                'Téléphone': '',
                'Créneau': '',
                'Montant': '',
                'Statut': '',
                'Catégorie': ''
            });
            
            filteredData.push({
                Date: '',
                Type: 'Total Recettes',
                'Client/Description': '',
                'Téléphone': '',
                'Créneau': '',
                'Montant': totalRecettes,
                'Statut': '',
                'Catégorie': ''
            });
            
            filteredData.push({
                Date: '',
                Type: 'Total Dépenses',
                'Client/Description': '',
                'Téléphone': '',
                'Créneau': '',
                'Montant': totalDepenses,
                'Statut': '',
                'Catégorie': ''
            });
            
            filteredData.push({
                Date: '',
                Type: 'SOLDE NET',
                'Client/Description': '',
                'Téléphone': '',
                'Créneau': '',
                'Montant': solde,
                'Statut': '',
                'Catégorie': ''
            });
            
            // Créer le classeur Excel
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(filteredData);
            
            // Définir la largeur des colonnes
            const colWidths = [
                { wch: 12 }, // Date
                { wch: 15 }, // Type
                { wch: 25 }, // Client/Description
                { wch: 15 }, // Téléphone
                { wch: 15 }, // Créneau
                { wch: 10 }, // Montant
                { wch: 12 }, // Statut
                { wch: 15 }  // Catégorie
            ];
            ws['!cols'] = colWidths;
            
            // Ajouter la feuille au classeur
            XLSX.utils.book_append_sheet(wb, ws, "Historique");
            
            // Télécharger le fichier Excel
            const fileName = `Historique_${startDate}_${endDate}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        function loadStatistiques() {
            updateStatsView();
        }

        function updateStatsView() {
            const timeFilter = document.getElementById('statsTimeFilter').value;
            updateStatsOverview(timeFilter);
            updateFinancialSummary(timeFilter);
            updateTransactionJournal();
            updateCharts(timeFilter);
        }

        function updateStatsOverview(timeFilter) {
            const now = new Date();
            let filteredTransactions = [];
            let periodLabel = '';

            switch (timeFilter) {
                case 'day':
                    const today = now.toISOString().split('T')[0];
                    filteredTransactions = transactions.filter(t => t.date === today);
                    periodLabel = 'Aujourd\'hui';
                    break;
                case 'month':
                    const currentMonth = now.getMonth();
                    const currentYear = now.getFullYear();
                    filteredTransactions = transactions.filter(t => {
                        const transactionDate = new Date(t.date);
                        return transactionDate.getMonth() === currentMonth && transactionDate.getFullYear() === currentYear;
                    });
                    periodLabel = 'Ce mois';
                    break;
                case 'year':
                    filteredTransactions = transactions.filter(t => {
                        const transactionDate = new Date(t.date);
                        return transactionDate.getFullYear() === now.getFullYear();
                    });
                    periodLabel = 'Cette année';
                    break;
            }

            const totalIncome = filteredTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = filteredTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const netProfit = totalIncome - totalExpenses;
            const transactionCount = filteredTransactions.length;

            document.getElementById('statsOverview').innerHTML = `
                <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-lg p-4 text-white">
                    <h4 class="text-sm font-medium opacity-90">Entrées ${periodLabel}</h4>
                    <p class="text-2xl font-bold">+${totalIncome.toFixed(2)}€</p>
                </div>
                <div class="bg-gradient-to-r from-red-500 to-red-600 rounded-lg p-4 text-white">
                    <h4 class="text-sm font-medium opacity-90">Sorties ${periodLabel}</h4>
                    <p class="text-2xl font-bold">-${totalExpenses.toFixed(2)}€</p>
                </div>
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg p-4 text-white">
                    <h4 class="text-sm font-medium opacity-90">Bénéfice ${periodLabel}</h4>
                    <p class="text-2xl font-bold">${netProfit >= 0 ? '+' : ''}${netProfit.toFixed(2)}€</p>
                </div>
                <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg p-4 text-white">
                    <h4 class="text-sm font-medium opacity-90">Transactions ${periodLabel}</h4>
                    <p class="text-2xl font-bold">${transactionCount}</p>
                </div>
            `;
        }

        function updateFinancialSummary(timeFilter) {
            const now = new Date();
            let periods = [];
            let periodFormat = '';

            switch (timeFilter) {
                case 'day':
                    // Derniers 7 jours
                    for (let i = 6; i >= 0; i--) {
                        const date = new Date(now);
                        date.setDate(date.getDate() - i);
                        periods.push(date.toISOString().split('T')[0]);
                    }
                    periodFormat = 'day';
                    break;
                case 'month':
                    // Derniers 6 mois
                    for (let i = 5; i >= 0; i--) {
                        const date = new Date(now);
                        date.setMonth(date.getMonth() - i);
                        periods.push(`${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`);
                    }
                    periodFormat = 'month';
                    break;
                case 'year':
                    // Dernières 3 années
                    for (let i = 2; i >= 0; i--) {
                        periods.push((now.getFullYear() - i).toString());
                    }
                    periodFormat = 'year';
                    break;
            }

            let cumulativeBalance = 0;
            const summaryHtml = periods.map((period, index) => {
                let periodTransactions = [];
                let displayPeriod = '';

                switch (periodFormat) {
                    case 'day':
                        periodTransactions = transactions.filter(t => t.date === period);
                        displayPeriod = new Date(period).toLocaleDateString('fr-FR');
                        break;
                    case 'month':
                        periodTransactions = transactions.filter(t => t.date.startsWith(period));
                        const [year, month] = period.split('-');
                        displayPeriod = new Date(year, month - 1).toLocaleDateString('fr-FR', { year: 'numeric', month: 'long' });
                        break;
                    case 'year':
                        periodTransactions = transactions.filter(t => t.date.startsWith(period));
                        displayPeriod = period;
                        break;
                }

                const income = periodTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const expenses = periodTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                const balance = income - expenses;
                cumulativeBalance += balance;

                const evolution = index > 0 ? ((balance / (periods.length > 1 ? 1 : 1)) * 100).toFixed(1) : '0.0';
                const evolutionClass = balance >= 0 ? 'text-green-600' : 'text-red-600';
                const evolutionIcon = balance >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';

                return `
                    <tr class="border-b border-gray-100">
                        <td class="py-3 px-4 text-sm text-gray-800">${displayPeriod}</td>
                        <td class="py-3 px-4 text-right text-sm font-medium text-green-600">+${income.toFixed(2)}€</td>
                        <td class="py-3 px-4 text-right text-sm font-medium text-red-600">-${expenses.toFixed(2)}€</td>
                        <td class="py-3 px-4 text-right text-sm font-bold ${evolutionClass}">${balance >= 0 ? '+' : ''}${balance.toFixed(2)}€</td>
                        <td class="py-3 px-4 text-right text-sm ${evolutionClass}">
                            <i class="fas ${evolutionIcon} mr-1"></i>${Math.abs(parseFloat(evolution))}%
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('financialSummary').innerHTML = summaryHtml;
        }

        function updateTransactionJournal() {
            const sortedTransactions = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            let cumulativeBalance = 0;

            // Calculer les totaux
            const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const finalBalance = totalIncome - totalExpenses;

            const journalHtml = sortedTransactions.map(transaction => {
                const isIncome = transaction.type === 'income';
                cumulativeBalance += isIncome ? transaction.amount : -transaction.amount;

                const categoryColors = {
                    'reservation': 'bg-blue-100 text-blue-800',
                    'maintenance': 'bg-orange-100 text-orange-800',
                    'equipement': 'bg-purple-100 text-purple-800',
                    'utilities': 'bg-yellow-100 text-yellow-800',
                    'other': 'bg-gray-100 text-gray-800'
                };

                const categoryNames = {
                    'reservation': 'Réservation',
                    'maintenance': 'Maintenance',
                    'equipement': 'Équipement',
                    'utilities': 'Factures',
                    'other': 'Autre'
                };

                const categoryClass = categoryColors[transaction.category] || 'bg-gray-100 text-gray-800';
                const categoryName = categoryNames[transaction.category] || 'Non défini';

                return `
                    <tr class="border-b border-gray-50">
                        <td class="py-2 px-4 text-sm text-gray-600">${new Date(transaction.date).toLocaleDateString('fr-FR')}</td>
                        <td class="py-2 px-4 text-sm text-gray-800">${transaction.description}</td>
                        <td class="py-2 px-4">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${categoryClass}">${categoryName}</span>
                        </td>
                        <td class="py-2 px-4 text-right text-sm font-medium ${isIncome ? 'text-green-600' : ''}">${isIncome ? transaction.amount.toFixed(2) + '€' : '-'}</td>
                        <td class="py-2 px-4 text-right text-sm font-medium ${!isIncome ? 'text-red-600' : ''}">${!isIncome ? transaction.amount.toFixed(2) + '€' : '-'}</td>
                        <td class="py-2 px-4 text-right text-sm font-bold ${cumulativeBalance >= 0 ? 'text-green-600' : 'text-red-600'}">${cumulativeBalance.toFixed(2)}€</td>
                    </tr>
                `;
            }).join('');

            // Ajouter la ligne de totaux
            const totalsRow = `
                <tr class="border-t-2 border-gray-300 bg-gray-50 font-bold">
                    <td class="py-3 px-4 text-sm font-bold text-gray-800" colspan="3">TOTAUX</td>
                    <td class="py-3 px-4 text-right text-sm font-bold text-green-600">+${totalIncome.toFixed(2)}€</td>
                    <td class="py-3 px-4 text-right text-sm font-bold text-red-600">-${totalExpenses.toFixed(2)}€</td>
                    <td class="py-3 px-4 text-right text-sm font-bold ${finalBalance >= 0 ? 'text-green-600' : 'text-red-600'}">${finalBalance >= 0 ? '+' : ''}${finalBalance.toFixed(2)}€</td>
                </tr>
            `;

            document.getElementById('transactionJournal').innerHTML = journalHtml + totalsRow;
        }

        function updateCharts(timeFilter) {
            // Revenue Chart - Utiliser les vraies données
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            
            // Clear existing chart
            if (window.revenueChart) {
                window.revenueChart.destroy();
            }

            let labels = [];
            let revenueData = [];
            let expenseData = [];
            const now = new Date();

            // S'assurer qu'il y a des données à afficher
            if (transactions.length === 0) {
                // Données d'exemple si aucune transaction
                labels = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
                revenueData = [0, 0, 0, 0, 0, 0, 0];
                expenseData = [0, 0, 0, 0, 0, 0, 0];
            } else {
                switch (timeFilter) {
                    case 'day':
                        // Derniers 7 jours
                        for (let i = 6; i >= 0; i--) {
                            const date = new Date(now);
                            date.setDate(date.getDate() - i);
                            const dateStr = date.toISOString().split('T')[0];
                            labels.push(date.toLocaleDateString('fr-FR', { weekday: 'short' }));
                            
                            const dayRevenue = transactions
                                .filter(t => t.date === dateStr && t.type === 'income')
                                .reduce((sum, t) => sum + t.amount, 0);
                            const dayExpenses = transactions
                                .filter(t => t.date === dateStr && t.type === 'expense')
                                .reduce((sum, t) => sum + t.amount, 0);
                            
                            revenueData.push(dayRevenue);
                            expenseData.push(dayExpenses);
                        }
                        break;
                    case 'month':
                        // Derniers 6 mois
                        for (let i = 5; i >= 0; i--) {
                            const date = new Date(now);
                            date.setMonth(date.getMonth() - i);
                            const monthStr = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                            labels.push(date.toLocaleDateString('fr-FR', { month: 'short' }));
                            
                            const monthRevenue = transactions
                                .filter(t => t.date.startsWith(monthStr) && t.type === 'income')
                                .reduce((sum, t) => sum + t.amount, 0);
                            const monthExpenses = transactions
                                .filter(t => t.date.startsWith(monthStr) && t.type === 'expense')
                                .reduce((sum, t) => sum + t.amount, 0);
                            
                            revenueData.push(monthRevenue);
                            expenseData.push(monthExpenses);
                        }
                        break;
                    case 'year':
                        // Dernières 3 années
                        for (let i = 2; i >= 0; i--) {
                            const year = (now.getFullYear() - i).toString();
                            labels.push(year);
                            
                            const yearRevenue = transactions
                                .filter(t => t.date.startsWith(year) && t.type === 'income')
                                .reduce((sum, t) => sum + t.amount, 0);
                            const yearExpenses = transactions
                                .filter(t => t.date.startsWith(year) && t.type === 'expense')
                                .reduce((sum, t) => sum + t.amount, 0);
                            
                            revenueData.push(yearRevenue);
                            expenseData.push(yearExpenses);
                        }
                        break;
                }
            }

            window.revenueChart = new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Revenus',
                        data: revenueData,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Dépenses',
                        data: expenseData,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y + '€';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + '€';
                                }
                            }
                        }
                    }
                }
            });

            // Slots Chart - Analyser les créneaux les plus réservés
            const slotsCtx = document.getElementById('slotsChart').getContext('2d');
            
            if (window.slotsChart) {
                window.slotsChart.destroy();
            }

            // Compter les réservations par créneau horaire
            const slotCounts = {};
            reservations.forEach(reservation => {
                const timeSlot = reservation.time;
                slotCounts[timeSlot] = (slotCounts[timeSlot] || 0) + 1;
            });

            // Trier et prendre les 5 créneaux les plus populaires
            const sortedSlots = Object.entries(slotCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);

            let slotLabels = sortedSlots.map(([slot]) => slot);
            let slotData = sortedSlots.map(([,count]) => count);

            // Si pas assez de données, ajouter des créneaux par défaut
            if (slotLabels.length === 0) {
                slotLabels = ['08:00-08:30', '10:00-10:30', '14:00-14:30', '16:00-16:30', '18:00-18:30'];
                slotData = [2, 1, 3, 2, 1];
            }

            window.slotsChart = new Chart(slotsCtx, {
                type: 'doughnut',
                data: {
                    labels: slotLabels,
                    datasets: [{
                        data: slotData,
                        backgroundColor: [
                            '#3b82f6',
                            '#10b981',
                            '#f59e0b',
                            '#ef4444',
                            '#8b5cf6'
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((context.parsed * 100) / total).toFixed(1) : '0.0';
                                    return context.label + ': ' + context.parsed + ' réservations (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        function generateReport() {
            const timeFilter = document.getElementById('statsTimeFilter').value;
            const now = new Date();
            let periodLabel = '';
            let filteredTransactions = [];
            let filteredReservations = [];

            // Filtrer les données selon la période
            switch (timeFilter) {
                case 'day':
                    const today = now.toISOString().split('T')[0];
                    filteredTransactions = transactions.filter(t => t.date === today);
                    filteredReservations = reservations.filter(r => r.date === today);
                    periodLabel = 'du ' + now.toLocaleDateString('fr-FR');
                    break;
                case 'month':
                    const currentMonth = now.getMonth();
                    const currentYear = now.getFullYear();
                    filteredTransactions = transactions.filter(t => {
                        const transactionDate = new Date(t.date);
                        return transactionDate.getMonth() === currentMonth && transactionDate.getFullYear() === currentYear;
                    });
                    filteredReservations = reservations.filter(r => {
                        const reservationDate = new Date(r.date);
                        return reservationDate.getMonth() === currentMonth && reservationDate.getFullYear() === currentYear;
                    });
                    periodLabel = 'de ' + now.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
                    break;
                case 'year':
                    filteredTransactions = transactions.filter(t => {
                        const transactionDate = new Date(t.date);
                        return transactionDate.getFullYear() === now.getFullYear();
                    });
                    filteredReservations = reservations.filter(r => {
                        const reservationDate = new Date(r.date);
                        return reservationDate.getFullYear() === now.getFullYear();
                    });
                    periodLabel = 'de l\'année ' + now.getFullYear();
                    break;
            }

            // Calculer les statistiques
            const totalIncome = filteredTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = filteredTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const netProfit = totalIncome - totalExpenses;
            const totalReservations = filteredReservations.length;
            const paidReservations = filteredReservations.filter(r => r.paid).length;
            const unpaidReservations = totalReservations - paidReservations;

            // Analyser les dépenses par catégorie
            const expensesByCategory = {};
            filteredTransactions.filter(t => t.type === 'expense').forEach(t => {
                const categoryNames = {
                    'maintenance': 'Maintenance',
                    'equipement': 'Équipement',
                    'utilities': 'Factures',
                    'other': 'Autre'
                };
                const categoryName = categoryNames[t.category] || 'Non défini';
                expensesByCategory[categoryName] = (expensesByCategory[categoryName] || 0) + t.amount;
            });

            // Analyser les créneaux populaires
            const slotCounts = {};
            filteredReservations.forEach(reservation => {
                const timeSlot = reservation.time;
                slotCounts[timeSlot] = (slotCounts[timeSlot] || 0) + 1;
            });
            const popularSlots = Object.entries(slotCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);

            // Créer le classeur Excel avec plusieurs feuilles
            const wb = XLSX.utils.book_new();

            // Feuille 1: Résumé Exécutif
            const summaryData = [
                { 'Indicateur': 'Période d\'analyse', 'Valeur': periodLabel },
                { 'Indicateur': '', 'Valeur': '' },
                { 'Indicateur': 'FINANCES', 'Valeur': '' },
                { 'Indicateur': 'Total des recettes', 'Valeur': totalIncome + ' €' },
                { 'Indicateur': 'Total des dépenses', 'Valeur': totalExpenses + ' €' },
                { 'Indicateur': 'Bénéfice net', 'Valeur': netProfit + ' €' },
                { 'Indicateur': 'Marge bénéficiaire', 'Valeur': totalIncome > 0 ? ((netProfit / totalIncome) * 100).toFixed(1) + ' %' : '0 %' },
                { 'Indicateur': '', 'Valeur': '' },
                { 'Indicateur': 'RÉSERVATIONS', 'Valeur': '' },
                { 'Indicateur': 'Total réservations', 'Valeur': totalReservations },
                { 'Indicateur': 'Réservations payées', 'Valeur': paidReservations },
                { 'Indicateur': 'Réservations impayées', 'Valeur': unpaidReservations },
                { 'Indicateur': 'Taux de paiement', 'Valeur': totalReservations > 0 ? ((paidReservations / totalReservations) * 100).toFixed(1) + ' %' : '0 %' },
                { 'Indicateur': 'Recette moyenne par réservation', 'Valeur': totalReservations > 0 ? (totalIncome / totalReservations).toFixed(2) + ' €' : '0 €' }
            ];

            const summaryWs = XLSX.utils.json_to_sheet(summaryData);
            summaryWs['!cols'] = [{ wch: 25 }, { wch: 20 }];
            XLSX.utils.book_append_sheet(wb, summaryWs, "Résumé Exécutif");

            // Feuille 2: Détail des Transactions
            const transactionData = filteredTransactions.map(t => ({
                Date: new Date(t.date).toLocaleDateString('fr-FR'),
                Type: t.type === 'income' ? 'Recette' : 'Dépense',
                Description: t.description,
                Catégorie: {
                    'reservation': 'Réservation',
                    'maintenance': 'Maintenance',
                    'equipement': 'Équipement',
                    'utilities': 'Factures',
                    'other': 'Autre'
                }[t.category] || 'Non défini',
                Montant: t.amount
            }));

            if (transactionData.length > 0) {
                const transactionWs = XLSX.utils.json_to_sheet(transactionData);
                transactionWs['!cols'] = [{ wch: 12 }, { wch: 12 }, { wch: 30 }, { wch: 15 }, { wch: 12 }];
                XLSX.utils.book_append_sheet(wb, transactionWs, "Détail Transactions");
            }

            // Feuille 3: Analyse des Dépenses
            const expenseAnalysis = Object.entries(expensesByCategory).map(([category, amount]) => ({
                Catégorie: category,
                Montant: amount,
                Pourcentage: totalExpenses > 0 ? ((amount / totalExpenses) * 100).toFixed(1) + ' %' : '0 %'
            }));

            if (expenseAnalysis.length > 0) {
                const expenseWs = XLSX.utils.json_to_sheet(expenseAnalysis);
                expenseWs['!cols'] = [{ wch: 20 }, { wch: 15 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(wb, expenseWs, "Analyse Dépenses");
            }

            // Feuille 4: Créneaux Populaires
            const slotsAnalysis = popularSlots.map(([slot, count]) => ({
                Créneau: slot,
                'Nombre de réservations': count,
                Pourcentage: totalReservations > 0 ? ((count / totalReservations) * 100).toFixed(1) + ' %' : '0 %'
            }));

            if (slotsAnalysis.length > 0) {
                const slotsWs = XLSX.utils.json_to_sheet(slotsAnalysis);
                slotsWs['!cols'] = [{ wch: 20 }, { wch: 20 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(wb, slotsWs, "Créneaux Populaires");
            }

            // Feuille 5: Liste des Réservations
            const reservationData = filteredReservations.map(r => ({
                Date: new Date(r.date).toLocaleDateString('fr-FR'),
                Créneau: r.time,
                Client: r.client,
                Téléphone: r.phone,
                Montant: r.amount,
                Statut: r.paid ? 'Payé' : 'Réservé'
            }));

            if (reservationData.length > 0) {
                const reservationWs = XLSX.utils.json_to_sheet(reservationData);
                reservationWs['!cols'] = [{ wch: 12 }, { wch: 15 }, { wch: 20 }, { wch: 15 }, { wch: 10 }, { wch: 12 }];
                XLSX.utils.book_append_sheet(wb, reservationWs, "Liste Réservations");
            }

            // Télécharger le fichier Excel
            const fileName = `Bilan_${timeFilter}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        function exportJournal() {
            const sortedTransactions = [...transactions].sort((a, b) => new Date(a.date) - new Date(b.date));
            let cumulativeBalance = 0;

            // Calculer les totaux
            const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const finalBalance = totalIncome - totalExpenses;

            // Préparer les données pour Excel
            const journalData = [];
            
            sortedTransactions.forEach(transaction => {
                const isIncome = transaction.type === 'income';
                cumulativeBalance += isIncome ? transaction.amount : -transaction.amount;
                
                const categoryNames = {
                    'reservation': 'Réservation',
                    'maintenance': 'Maintenance',
                    'equipement': 'Équipement',
                    'utilities': 'Factures',
                    'other': 'Autre'
                };
                
                const categoryName = categoryNames[transaction.category] || 'Non défini';
                
                journalData.push({
                    Date: new Date(transaction.date).toLocaleDateString('fr-FR'),
                    Description: transaction.description,
                    'Catégorie': categoryName,
                    'Entrées': isIncome ? transaction.amount : '',
                    'Sorties': !isIncome ? transaction.amount : '',
                    'Solde Cumulé': cumulativeBalance
                });
            });
            
            // Ajouter les lignes de totaux
            journalData.push({
                Date: '',
                Description: '',
                'Catégorie': '',
                'Entrées': '',
                'Sorties': '',
                'Solde Cumulé': ''
            });
            
            journalData.push({
                Date: 'TOTAUX',
                Description: '',
                'Catégorie': '',
                'Entrées': totalIncome,
                'Sorties': totalExpenses,
                'Solde Cumulé': finalBalance
            });
            
            // Créer le classeur Excel
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(journalData);
            
            // Définir la largeur des colonnes
            const colWidths = [
                { wch: 12 }, // Date
                { wch: 30 }, // Description
                { wch: 15 }, // Catégorie
                { wch: 12 }, // Entrées
                { wch: 12 }, // Sorties
                { wch: 15 }  // Solde Cumulé
            ];
            ws['!cols'] = colWidths;
            
            // Ajouter la feuille au classeur
            XLSX.utils.book_append_sheet(wb, ws, "Journal Comptable");
            
            // Télécharger le fichier Excel
            const fileName = `Journal_Comptable_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        // Client Management Functions
        function loadClients() {
            const clientsHtml = clients.map(client => {
                const clientReservations = reservations.filter(r => r.clientId === client.id);
                const lastReservation = clientReservations.length > 0 ? 
                    Math.max(...clientReservations.map(r => new Date(r.date))) : null;
                const lastVisit = lastReservation ? new Date(lastReservation).toLocaleDateString('fr-FR') : 'Jamais';
                
                return `
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-3 px-4">
                            <div class="flex items-center space-x-3">
                                <div class="bg-blue-100 w-10 h-10 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user text-blue-600"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-800">${client.name}</p>
                                    <p class="text-sm text-gray-500">Client depuis ${new Date(client.createdAt).toLocaleDateString('fr-FR')}</p>
                                </div>
                            </div>
                        </td>
                        <td class="py-3 px-4 text-sm text-gray-600">${client.phone}</td>
                        <td class="py-3 px-4 text-sm text-gray-600">${client.email || 'Non renseigné'}</td>
                        <td class="py-3 px-4 text-sm text-gray-600">${clientReservations.length}</td>
                        <td class="py-3 px-4 text-sm text-gray-600">${lastVisit}</td>
                        <td class="py-3 px-4 text-center">
                            <div class="flex items-center justify-center space-x-2">
                                <button onclick="viewClientDetails(${client.id})" class="text-blue-600 hover:text-blue-800 transition-colors">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="editClient(${client.id})" class="text-green-600 hover:text-green-800 transition-colors">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteClient(${client.id})" class="text-red-600 hover:text-red-800 transition-colors">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('clientsList').innerHTML = clientsHtml;
            populateClientSelect();
        }

        function populateClientSelect() {
            const select = document.getElementById('existingClient');
            select.innerHTML = '<option value="">Sélectionner un client existant</option>';
            
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = `${client.name} - ${client.phone}`;
                select.appendChild(option);
            });
        }

        function searchClients() {
            const searchTerm = document.getElementById('clientSearch').value.toLowerCase();
            const filteredClients = clients.filter(client => 
                client.name.toLowerCase().includes(searchTerm) ||
                client.phone.includes(searchTerm) ||
                (client.email && client.email.toLowerCase().includes(searchTerm))
            );
            
            // Update display with filtered clients
            const clientsHtml = filteredClients.map(client => {
                const clientReservations = reservations.filter(r => r.clientId === client.id);
                const lastReservation = clientReservations.length > 0 ? 
                    Math.max(...clientReservations.map(r => new Date(r.date))) : null;
                const lastVisit = lastReservation ? new Date(lastReservation).toLocaleDateString('fr-FR') : 'Jamais';
                
                return `
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-3 px-4">
                            <div class="flex items-center space-x-3">
                                <div class="bg-blue-100 w-10 h-10 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user text-blue-600"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-gray-800">${client.name}</p>
                                    <p class="text-sm text-gray-500">Client depuis ${new Date(client.createdAt).toLocaleDateString('fr-FR')}</p>
                                </div>
                            </div>
                        </td>
                        <td class="py-3 px-4 text-sm text-gray-600">${client.phone}</td>
                        <td class="py-3 px-4 text-sm text-gray-600">${client.email || 'Non renseigné'}</td>
                        <td class="py-3 px-4 text-sm text-gray-600">${clientReservations.length}</td>
                        <td class="py-3 px-4 text-sm text-gray-600">${lastVisit}</td>
                        <td class="py-3 px-4 text-center">
                            <div class="flex items-center justify-center space-x-2">
                                <button onclick="viewClientDetails(${client.id})" class="text-blue-600 hover:text-blue-800 transition-colors">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="editClient(${client.id})" class="text-green-600 hover:text-green-800 transition-colors">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteClient(${client.id})" class="text-red-600 hover:text-red-800 transition-colors">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('clientsList').innerHTML = clientsHtml;
        }

        function openClientModal() {
            isEditingClient = false;
            currentClientId = null;
            document.getElementById('clientModalTitle').textContent = 'Nouveau client';
            resetClientForm();
            document.getElementById('clientModal').classList.remove('hidden');
            document.getElementById('clientModal').classList.add('flex');
        }

        function openClientModalFromReservation() {
            openClientModal();
        }

        function closeClientModal() {
            document.getElementById('clientModal').classList.add('hidden');
            document.getElementById('clientModal').classList.remove('flex');
            resetClientForm();
        }

        function resetClientForm() {
            document.getElementById('clientId').value = '';
            document.getElementById('clientFullName').value = '';
            document.getElementById('clientPhoneNumber').value = '';
            document.getElementById('clientEmail').value = '';
            document.getElementById('clientAddress').value = '';
            document.getElementById('clientBirthDate').value = '';
            document.getElementById('clientNotes').value = '';
        }

        async function saveClient(event) {
            event.preventDefault();
            
            const clientData = {
                name: document.getElementById('clientFullName').value,
                phone: document.getElementById('clientPhoneNumber').value,
                email: document.getElementById('clientEmail').value,
                address: document.getElementById('clientAddress').value,
                birthDate: document.getElementById('clientBirthDate').value,
                notes: document.getElementById('clientNotes').value
            };

            if (isEditingClient && currentClientId) {
                // Update existing client
                const clientIndex = clients.findIndex(c => c.id === currentClientId);
                if (clientIndex !== -1) {
                    clients[clientIndex] = { ...clients[clientIndex], ...clientData };
                    
                    // Update reservations with new client name
                    reservations.forEach(reservation => {
                        if (reservation.clientId === currentClientId) {
                            reservation.client = clientData.name;
                            reservation.phone = clientData.phone;
                        }
                    });
                }
            } else {
                // Create new client
                const newClient = {
                    id: Date.now(),
                    ...clientData,
                    createdAt: new Date().toISOString().split('T')[0]
                };
                clients.push(newClient);
            }
            
            // Sauvegarder sur GitHub
            await dataStorage.saveData();
            githubStorage.markPendingChanges();
            
            // Synchronisation immédiate si auto-sync activé
            if (githubStorage.isEnabled) {
                setTimeout(() => {
                    githubStorage.pushToGitHub();
                }, 1000);
            }
            closeClientModal();
            loadClients();
            
            // If we came from reservation modal, populate the fields
            if (document.getElementById('reservationModal').classList.contains('flex')) {
                const newClient = clients[clients.length - 1];
                document.getElementById('clientName').value = newClient.name;
                document.getElementById('clientPhone').value = newClient.phone;
                populateClientSelect();
                document.getElementById('existingClient').value = newClient.id;
            }
        }

        function editClient(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (client) {
                isEditingClient = true;
                currentClientId = clientId;
                document.getElementById('clientModalTitle').textContent = 'Modifier le client';
                
                document.getElementById('clientId').value = client.id;
                document.getElementById('clientFullName').value = client.name;
                document.getElementById('clientPhoneNumber').value = client.phone;
                document.getElementById('clientEmail').value = client.email || '';
                document.getElementById('clientAddress').value = client.address || '';
                document.getElementById('clientBirthDate').value = client.birthDate || '';
                document.getElementById('clientNotes').value = client.notes || '';
                
                document.getElementById('clientModal').classList.remove('hidden');
                document.getElementById('clientModal').classList.add('flex');
            }
        }

        async function deleteClient(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (client && confirm(`Êtes-vous sûr de vouloir supprimer le client "${client.name}" ?\n\nCette action supprimera également toutes ses réservations.`)) {
                // Remove client
                clients = clients.filter(c => c.id !== clientId);
                
                // Remove client's reservations
                reservations = reservations.filter(r => r.clientId !== clientId);
                
                // Remove client's transactions
                transactions = transactions.filter(t => !t.description.includes(client.name));
                
                // Sauvegarder localement
                localDB.saveData();
                
                loadClients();
                if (currentPage === 'dashboard') loadDashboard();
            }
        }

        function viewClientDetails(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (client) {
                currentClientId = clientId;
                
                // Populate client info
                const clientInfo = `
                    <div class="space-y-2">
                        <p><span class="font-medium">Nom:</span> ${client.name}</p>
                        <p><span class="font-medium">Téléphone:</span> ${client.phone}</p>
                        <p><span class="font-medium">Email:</span> ${client.email || 'Non renseigné'}</p>
                        <p><span class="font-medium">Adresse:</span> ${client.address || 'Non renseignée'}</p>
                        <p><span class="font-medium">Date de naissance:</span> ${client.birthDate ? new Date(client.birthDate).toLocaleDateString('fr-FR') : 'Non renseignée'}</p>
                        <p><span class="font-medium">Client depuis:</span> ${new Date(client.createdAt).toLocaleDateString('fr-FR')}</p>
                        ${client.notes ? `<p><span class="font-medium">Notes:</span> ${client.notes}</p>` : ''}
                    </div>
                `;
                document.getElementById('clientDetailsInfo').innerHTML = clientInfo;
                
                // Populate reservations history
                const clientReservations = reservations.filter(r => r.clientId === clientId);
                const reservationsHtml = clientReservations.length > 0 ? 
                    clientReservations.map(reservation => {
                        const statusClass = reservation.paid ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                        const status = reservation.paid ? 'Payé' : 'Réservé';
                        
                        return `
                            <div class="flex items-center justify-between p-3 bg-white rounded border">
                                <div>
                                    <p class="font-medium text-gray-800">${new Date(reservation.date).toLocaleDateString('fr-FR')}</p>
                                    <p class="text-sm text-gray-600">${reservation.time}</p>
                                </div>
                                <div class="text-right">
                                    <p class="font-medium text-gray-800">${reservation.amount.toLocaleString('fr-FR')} Ar</p>
                                    <span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">${status}</span>
                                </div>
                            </div>
                        `;
                    }).join('') : '<p class="text-gray-500 text-center py-4">Aucune réservation</p>';
                
                document.getElementById('clientReservationsHistory').innerHTML = reservationsHtml;
                
                document.getElementById('clientDetailsModal').classList.remove('hidden');
                document.getElementById('clientDetailsModal').classList.add('flex');
            }
        }

        function closeClientDetailsModal() {
            document.getElementById('clientDetailsModal').classList.add('hidden');
            document.getElementById('clientDetailsModal').classList.remove('flex');
        }

        function editClientFromDetails() {
            closeClientDetailsModal();
            editClient(currentClientId);
        }

        function deleteClientFromDetails() {
            closeClientDetailsModal();
            deleteClient(currentClientId);
        }

        function selectExistingClient() {
            const clientId = parseInt(document.getElementById('existingClient').value);
            if (clientId) {
                const client = clients.find(c => c.id === clientId);
                if (client) {
                    document.getElementById('clientName').value = client.name;
                    document.getElementById('clientPhone').value = client.phone;
                }
            } else {
                document.getElementById('clientName').value = '';
                document.getElementById('clientPhone').value = '';
            }
        }

        // Update saveReservation to include clientId
        async function saveReservation(event) {
            event.preventDefault();
            
            const clientId = parseInt(document.getElementById('existingClient').value) || null;
            const consecutiveSlots = parseInt(document.getElementById('consecutiveSlots').value);
            const selectedDate = document.getElementById('reservationDate').value;
            const allSlots = generateTimeSlots();
            const startSlotIndex = allSlots.indexOf(currentSlot);
            
            // Vérifier si tous les créneaux consécutifs sont disponibles
            const dateReservations = reservations.filter(r => r.date === selectedDate);
            for (let i = 0; i < consecutiveSlots; i++) {
                const slotToCheck = allSlots[startSlotIndex + i];
                if (!slotToCheck) {
                    alert('Pas assez de créneaux disponibles après celui sélectionné.');
                    return;
                }
                if (dateReservations.find(r => r.time === slotToCheck)) {
                    alert(`Le créneau ${slotToCheck} est déjà réservé. Veuillez choisir un autre créneau de départ.`);
                    return;
                }
            }
            
            // Créer les réservations pour tous les créneaux consécutifs
            const baseId = Date.now();
            const totalAmount = parseFloat(document.getElementById('reservationAmount').value);
            const amountPerSlot = totalAmount / consecutiveSlots;
            
            for (let i = 0; i < consecutiveSlots; i++) {
                const slotTime = allSlots[startSlotIndex + i];
                const reservation = {
                    id: baseId + i,
                    date: selectedDate,
                    time: slotTime,
                    clientId: clientId,
                    client: document.getElementById('clientName').value,
                    phone: document.getElementById('clientPhone').value,
                    amount: amountPerSlot,
                    paid: document.getElementById('isPaid').checked,
                    isConsecutive: consecutiveSlots > 1,
                    consecutiveGroup: baseId,
                    slotNumber: i + 1,
                    totalSlots: consecutiveSlots
                };
                
                reservations.push(reservation);
            }
            
            // Add transaction if paid
            if (document.getElementById('isPaid').checked) {
                const transaction = {
                    id: baseId,
                    date: selectedDate,
                    type: 'income',
                    description: `Réservation ${document.getElementById('clientName').value} (${consecutiveSlots} créneaux)`,
                    amount: totalAmount,
                    category: 'reservation'
                };
                transactions.push(transaction);
            }
            
            // Sauvegarder automatiquement sur GitHub
            await dataStorage.saveData();
            githubStorage.markPendingChanges();
            
            // Synchronisation immédiate si auto-sync activé
            if (githubStorage.isEnabled) {
                setTimeout(() => {
                    githubStorage.pushToGitHub();
                }, 1000); // Attendre 1 seconde puis synchroniser
            }
            
            closeModal();
            loadReservations();
            if (currentPage === 'dashboard') loadDashboard();
        }

        // New functions for history management
        function updatePeriodInputs() {
            const periodFilter = document.getElementById('periodFilter').value;
            const customInputs = document.getElementById('customDateInputs');
            const today = new Date();
            
            if (periodFilter === 'custom') {
                customInputs.style.display = 'flex';
                return;
            }
            
            customInputs.style.display = 'none';
            
            let startDate, endDate;
            
            switch (periodFilter) {
                case 'today':
                    startDate = endDate = today.toISOString().split('T')[0];
                    break;
                case 'week':
                    const startOfWeek = new Date(today);
                    startOfWeek.setDate(today.getDate() - today.getDay() + 1); // Lundi
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6); // Dimanche
                    startDate = startOfWeek.toISOString().split('T')[0];
                    endDate = endOfWeek.toISOString().split('T')[0];
                    break;
                case 'month':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];
                    break;
                case 'year':
                    startDate = new Date(today.getFullYear(), 0, 1).toISOString().split('T')[0];
                    endDate = new Date(today.getFullYear(), 11, 31).toISOString().split('T')[0];
                    break;
            }
            
            document.getElementById('historyStartDate').value = startDate;
            document.getElementById('historyEndDate').value = endDate;
            loadHistorique();
        }

        function toggleAllHistorySelection() {
            const selectAll = document.getElementById('selectAllHistory').checked;
            const checkboxes = document.querySelectorAll('.history-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll;
            });
        }

        function deleteHistoryItem(itemId) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cet élément de l\'historique ?')) {
                const [type, id] = itemId.split('_');
                const numId = parseInt(id);
                
                if (type === 'reservation') {
                    reservations = reservations.filter(r => r.id !== numId);
                    localStorage.setItem('reservations', JSON.stringify(reservations));
                } else if (type === 'transaction') {
                    transactions = transactions.filter(t => t.id !== numId);
                    localStorage.setItem('transactions', JSON.stringify(transactions));
                }
                
                loadHistorique();
                if (currentPage === 'dashboard') loadDashboard();
                if (currentPage === 'caisse') loadCaisse();
                if (currentPage === 'reservations') loadReservations();
            }
        }

        function deleteSelectedHistory() {
            const selectedCheckboxes = document.querySelectorAll('.history-checkbox:checked');
            
            if (selectedCheckboxes.length === 0) {
                alert('Veuillez sélectionner au moins un élément à supprimer.');
                return;
            }
            
            if (confirm(`Êtes-vous sûr de vouloir supprimer ${selectedCheckboxes.length} élément(s) sélectionné(s) ?`)) {
                selectedCheckboxes.forEach(checkbox => {
                    const itemId = checkbox.getAttribute('data-id');
                    const [type, id] = itemId.split('_');
                    const numId = parseInt(id);
                    
                    if (type === 'reservation') {
                        reservations = reservations.filter(r => r.id !== numId);
                    } else if (type === 'transaction') {
                        transactions = transactions.filter(t => t.id !== numId);
                    }
                });
                
                localStorage.setItem('reservations', JSON.stringify(reservations));
                localStorage.setItem('transactions', JSON.stringify(transactions));
                
                // Uncheck select all
                document.getElementById('selectAllHistory').checked = false;
                
                loadHistorique();
                if (currentPage === 'dashboard') loadDashboard();
                if (currentPage === 'caisse') loadCaisse();
                if (currentPage === 'reservations') loadReservations();
            }
        }

        // Administration Functions
        function loadAdministration() {
            // Charger les identifiants actuels
            const storedCredentials = JSON.parse(localStorage.getItem('userCredentials')) || {
                proprietaire: { username: 'admin', password: 'admin' },
                receptionniste: { username: 'user', password: 'user' }
            };
            
            document.getElementById('adminUsername').value = storedCredentials.proprietaire.username;
            document.getElementById('adminPassword').value = storedCredentials.proprietaire.password;
            document.getElementById('userUsername').value = storedCredentials.receptionniste.username;
            document.getElementById('userPassword').value = storedCredentials.receptionniste.password;
            
            // Charger le prix actuel
            document.getElementById('slotPriceInput').value = slotPrice;
            document.getElementById('currentSlotPrice').textContent = slotPrice.toLocaleString('fr-FR') + ' Ar';
            
            // Mettre à jour les statistiques des données
            updateDataStats();
            updateLocalStorageInfo();
            loadActivityLogs();
            
            // Mettre à jour le statut Git
            gitStorage.updateGitStatus();
            gitStorage.updateGitStats();
            updateGitStatusHeader();
        }

        // Nouvelles fonctions pour la gestion GitHub
        async function refreshData() {
            await dataStorage.loadData();
            
            // Recharger la page actuelle
            if (currentPage === 'dashboard') loadDashboard();
            if (currentPage === 'reservations') loadReservations();
            if (currentPage === 'clients') loadClients();
            if (currentPage === 'caisse') loadCaisse();
            if (currentPage === 'historique') loadHistorique();
            if (currentPage === 'statistiques') loadStatistiques();
            if (currentPage === 'database') loadDatabase();
            
            // Notification
            showNotification('✅ Données actualisées depuis GitHub');
        }

        async function refreshAllData() {
            await refreshData();
            updateDataStats();
        }



        function updateLocalStorageInfo() {
            const stats = localDB.getStorageStats();
            
            // Mettre à jour les éléments d'affichage
            const sizeElement = document.getElementById('localStorageSize');
            const recordsElement = document.getElementById('totalRecords');
            const lastModifiedElement = document.getElementById('lastModifiedTime');
            
            if (sizeElement) {
                sizeElement.textContent = stats.totalSizeKB;
            }
            
            if (recordsElement) {
                recordsElement.textContent = stats.reservationsCount + stats.transactionsCount + stats.clientsCount;
            }
            
            if (lastModifiedElement && stats.lastModified) {
                const lastMod = new Date(stats.lastModified);
                lastModifiedElement.textContent = lastMod.toLocaleString('fr-FR');
            }
        }

        function showNotification(message) {
            // Créer une notification temporaire
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-white border border-gray-200 rounded-lg shadow-lg p-3 z-50 animate-fade-in';
            notification.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="fas fa-database text-green-600"></i>
                    <span class="text-sm font-medium text-gray-800">${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Supprimer après 3 secondes
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function updateCredentials(event, role) {
            event.preventDefault();
            
            const storedCredentials = JSON.parse(localStorage.getItem('userCredentials')) || {
                proprietaire: { username: 'admin', password: 'admin' },
                receptionniste: { username: 'user', password: 'user' }
            };
            
            if (role === 'proprietaire') {
                const newUsername = document.getElementById('adminUsername').value;
                const newPassword = document.getElementById('adminPassword').value;
                
                if (newUsername && newPassword) {
                    storedCredentials.proprietaire = { username: newUsername, password: newPassword };
                    localStorage.setItem('userCredentials', JSON.stringify(storedCredentials));
                    
                    // Log de l'activité
                    logActivity('Modification identifiants propriétaire', `Nouveau nom d'utilisateur: ${newUsername}`);
                    
                    alert('Identifiants du propriétaire mis à jour avec succès !');
                } else {
                    alert('Veuillez remplir tous les champs.');
                }
            } else if (role === 'receptionniste') {
                const newUsername = document.getElementById('userUsername').value;
                const newPassword = document.getElementById('userPassword').value;
                
                if (newUsername && newPassword) {
                    storedCredentials.receptionniste = { username: newUsername, password: newPassword };
                    localStorage.setItem('userCredentials', JSON.stringify(storedCredentials));
                    
                    // Log de l'activité
                    logActivity('Modification identifiants réceptionniste', `Nouveau nom d'utilisateur: ${newUsername}`);
                    
                    alert('Identifiants du réceptionniste mis à jour avec succès !');
                } else {
                    alert('Veuillez remplir tous les champs.');
                }
            }
            
            loadActivityLogs();
        }

        function updateDataStats() {
            document.getElementById('totalReservationsCount').textContent = reservations.length;
            document.getElementById('totalTransactionsCount').textContent = transactions.length;
            document.getElementById('totalClientsCount').textContent = clients.length;
            
            // Calculer la taille des données en Ko
            const dataSize = (JSON.stringify(reservations).length + 
                            JSON.stringify(transactions).length + 
                            JSON.stringify(clients).length) / 1024;
            document.getElementById('totalDataSize').textContent = dataSize.toFixed(1);
        }

        function updateGitStatusHeader() {
            const statusElement = document.getElementById('gitStatusHeader');
            if (!statusElement) return;
            
            const dot = statusElement.querySelector('div');
            const text = statusElement.querySelector('span');
            
            if (githubStorage.isEnabled) {
                dot.className = 'w-3 h-3 bg-green-500 rounded-full';
                text.textContent = 'GitHub Auto';
                text.className = 'text-sm text-green-600';
            } else {
                dot.className = 'w-3 h-3 bg-orange-500 rounded-full';
                text.textContent = 'GitHub Manuel';
                text.className = 'text-sm text-orange-600';
            }
        }



        async function resetAllData() {
            // Première confirmation avec détails
            const confirmMessage = `⚠️ RÉINITIALISATION COMPLÈTE ⚠️

Cette action supprimera DÉFINITIVEMENT :
• ${reservations.length} réservations
• ${transactions.length} transactions  
• ${clients.length} clients
• Tous les logs d'activité

⚠️ CETTE ACTION EST IRRÉVERSIBLE ⚠️

Voulez-vous continuer ?`;

            if (confirm(confirmMessage)) {
                // Deuxième confirmation avec saisie
                const confirmText = prompt('Pour confirmer la réinitialisation complète, tapez "SUPPRIMER TOUT" (en majuscules) :');
                
                if (confirmText === 'SUPPRIMER TOUT') {
                    // Troisième et dernière confirmation
                    if (confirm('DERNIÈRE CONFIRMATION :\n\nVoulez-vous vraiment SUPPRIMER TOUTES LES DONNÉES ?\n\nCette action ne peut pas être annulée !')) {
                        
                        // Sauvegarder les statistiques avant suppression
                        const statsBeforeReset = {
                            reservations: reservations.length,
                            transactions: transactions.length,
                            clients: clients.length,
                            resetDate: new Date().toISOString(),
                            resetBy: currentUser ? currentUser.username : 'Inconnu'
                        };
                        
                        // Réinitialiser toutes les données
                        reservations = [];
                        transactions = [];
                        clients = [];
                        localStorage.removeItem('activityLogs');
                        
                        // Sauvegarder sur GitHub
                        await dataStorage.saveData();
                        githubStorage.markPendingChanges();
                        
                        // Log de la réinitialisation (nouveau log)
                        logActivity('🔄 RÉINITIALISATION COMPLÈTE', 
                            `Suppression de ${statsBeforeReset.reservations} réservations, ${statsBeforeReset.transactions} transactions, ${statsBeforeReset.clients} clients`);
                        
                        // Mettre à jour l'affichage
                        updateDataStats();
                        loadActivityLogs();
                        
                        // Message de confirmation
                        alert(`✅ RÉINITIALISATION TERMINÉE

Données supprimées :
• ${statsBeforeReset.reservations} réservations
• ${statsBeforeReset.transactions} transactions  
• ${statsBeforeReset.clients} clients

L'application a été réinitialisée.`);
                        
                        // Recharger toutes les pages
                        if (currentPage === 'dashboard') loadDashboard();
                        if (currentPage === 'reservations') loadReservations();
                        if (currentPage === 'caisse') loadCaisse();
                        if (currentPage === 'clients') loadClients();
                        if (currentPage === 'historique') loadHistorique();
                        if (currentPage === 'statistiques') loadStatistiques();
                    }
                } else if (confirmText !== null) {
                    alert('❌ Texte de confirmation incorrect.\n\nLa réinitialisation a été annulée pour votre sécurité.');
                }
            }
        }

        function resetSpecificData(dataType) {
            let confirmMessage = '';
            let dataCount = 0;
            
            switch(dataType) {
                case 'reservations':
                    dataCount = reservations.length;
                    confirmMessage = `Supprimer toutes les ${dataCount} réservations ?`;
                    break;
                case 'transactions':
                    dataCount = transactions.length;
                    confirmMessage = `Supprimer toutes les ${dataCount} transactions ?`;
                    break;
                case 'clients':
                    dataCount = clients.length;
                    confirmMessage = `Supprimer tous les ${dataCount} clients et leurs réservations ?`;
                    break;
            }
            
            if (confirm(`⚠️ ${confirmMessage}\n\nCette action est irréversible !`)) {
                switch(dataType) {
                    case 'reservations':
                        reservations = [];
                        localStorage.removeItem('reservations');
                        logActivity('Suppression réservations', `${dataCount} réservations supprimées`);
                        break;
                    case 'transactions':
                        transactions = [];
                        localStorage.removeItem('transactions');
                        logActivity('Suppression transactions', `${dataCount} transactions supprimées`);
                        break;
                    case 'clients':
                        // Supprimer aussi les réservations des clients
                        const clientReservations = reservations.filter(r => r.clientId);
                        reservations = reservations.filter(r => !r.clientId);
                        clients = [];
                        localStorage.setItem('reservations', JSON.stringify(reservations));
                        localStorage.removeItem('clients');
                        logActivity('Suppression clients', `${dataCount} clients et ${clientReservations.length} réservations supprimés`);
                        break;
                }
                
                updateDataStats();
                loadActivityLogs();
                alert(`✅ ${dataCount} éléments supprimés avec succès !`);
                
                // Recharger les pages concernées
                if (currentPage === 'dashboard') loadDashboard();
                if (currentPage === 'reservations') loadReservations();
                if (currentPage === 'caisse') loadCaisse();
                if (currentPage === 'clients') loadClients();
                if (currentPage === 'historique') loadHistorique();
            }
        }

        function logActivity(action, details) {
            const logs = JSON.parse(localStorage.getItem('activityLogs')) || [];
            const newLog = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                user: currentUser ? currentUser.username : 'Système',
                role: currentUser ? currentUser.role : 'système',
                action: action,
                details: details
            };
            
            logs.unshift(newLog); // Ajouter au début
            
            // Garder seulement les 50 derniers logs
            if (logs.length > 50) {
                logs.splice(50);
            }
            
            localStorage.setItem('activityLogs', JSON.stringify(logs));
        }

        function loadActivityLogs() {
            const logs = JSON.parse(localStorage.getItem('activityLogs')) || [];
            
            const logsHtml = logs.slice(0, 20).map(log => {
                const date = new Date(log.timestamp);
                const roleClass = log.role === 'proprietaire' ? 'text-blue-600' : 'text-green-600';
                
                return `
                    <tr class="border-b border-gray-50">
                        <td class="py-2 px-4 text-sm text-gray-600">
                            ${date.toLocaleDateString('fr-FR')} ${date.toLocaleTimeString('fr-FR')}
                        </td>
                        <td class="py-2 px-4 text-sm">
                            <span class="${roleClass} font-medium">${log.user}</span>
                            <span class="text-xs text-gray-500 ml-1">(${log.role})</span>
                        </td>
                        <td class="py-2 px-4 text-sm font-medium text-gray-800">${log.action}</td>
                        <td class="py-2 px-4 text-sm text-gray-600">${log.details}</td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('activityLogs').innerHTML = logsHtml || '<tr><td colspan="4" class="py-4 text-center text-gray-500">Aucune activité enregistrée</td></tr>';
        }

        // Database Management Functions
        function loadDatabase() {
            // Charger l'onglet réservations par défaut
            showDatabaseTab('reservations');
        }

        function showDatabaseTab(tabName) {
            // Masquer tous les onglets
            const tabs = ['reservations', 'transactions', 'clients', 'credentials', 'logs'];
            tabs.forEach(tab => {
                document.getElementById(`db${tab.charAt(0).toUpperCase() + tab.slice(1)}Tab`).classList.add('hidden');
            });

            // Afficher l'onglet sélectionné
            document.getElementById(`db${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Tab`).classList.remove('hidden');

            // Mettre à jour les styles des boutons d'onglets
            document.querySelectorAll('.database-tab').forEach(button => {
                button.classList.remove('border-blue-500', 'text-blue-600');
                button.classList.add('border-transparent', 'text-gray-500');
            });

            // Activer l'onglet sélectionné
            event.target.classList.remove('border-transparent', 'text-gray-500');
            event.target.classList.add('border-blue-500', 'text-blue-600');

            // Charger les données de l'onglet
            switch(tabName) {
                case 'reservations':
                    loadDatabaseReservations();
                    break;
                case 'transactions':
                    loadDatabaseTransactions();
                    break;
                case 'clients':
                    loadDatabaseClients();
                    break;
                case 'credentials':
                    loadDatabaseCredentials();
                    break;
                case 'logs':
                    loadDatabaseLogs();
                    break;
            }
        }

        function loadDatabaseReservations() {
            const reservationsHtml = reservations.map(reservation => {
                const statusBadge = reservation.paid ? 
                    '<span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">Oui</span>' :
                    '<span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800">Non</span>';

                return `
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-3 px-4 text-sm text-gray-600">${reservation.id}</td>
                        <td class="py-3 px-4 text-sm text-gray-800">${new Date(reservation.date).toLocaleDateString('fr-FR')}</td>
                        <td class="py-3 px-4 text-sm text-gray-800">${reservation.time}</td>
                        <td class="py-3 px-4 text-sm text-gray-800">${reservation.client}</td>
                        <td class="py-3 px-4 text-sm text-gray-600">${reservation.phone}</td>
                        <td class="py-3 px-4 text-right text-sm font-medium text-gray-800">${reservation.amount.toLocaleString('fr-FR')} Ar</td>
                        <td class="py-3 px-4 text-center">${statusBadge}</td>
                        <td class="py-3 px-4 text-center">
                            <div class="flex items-center justify-center space-x-2">
                                <button onclick="editDatabaseReservation(${reservation.id})" class="text-blue-600 hover:text-blue-800 transition-colors">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteDatabaseReservation(${reservation.id})" class="text-red-600 hover:text-red-800 transition-colors">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('dbReservationsList').innerHTML = reservationsHtml || 
                '<tr><td colspan="8" class="py-8 text-center text-gray-500">Aucune réservation</td></tr>';
        }

        function loadDatabaseTransactions() {
            const transactionsHtml = transactions.map(transaction => {
                const typeClass = transaction.type === 'income' ? 'text-green-600' : 'text-red-600';
                const typeText = transaction.type === 'income' ? 'Recette' : 'Dépense';
                const categoryNames = {
                    'reservation': 'Réservation',
                    'maintenance': 'Maintenance',
                    'equipement': 'Équipement',
                    'utilities': 'Factures',
                    'other': 'Autre'
                };

                return `
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-3 px-4 text-sm text-gray-600">${transaction.id}</td>
                        <td class="py-3 px-4 text-sm text-gray-800">${new Date(transaction.date).toLocaleDateString('fr-FR')}</td>
                        <td class="py-3 px-4 text-sm font-medium ${typeClass}">${typeText}</td>
                        <td class="py-3 px-4 text-sm text-gray-800">${transaction.description}</td>
                        <td class="py-3 px-4 text-sm text-gray-600">${categoryNames[transaction.category] || 'Non défini'}</td>
                        <td class="py-3 px-4 text-right text-sm font-medium ${typeClass}">${transaction.amount.toLocaleString('fr-FR')} Ar</td>
                        <td class="py-3 px-4 text-center">
                            <div class="flex items-center justify-center space-x-2">
                                <button onclick="editDatabaseTransaction(${transaction.id})" class="text-blue-600 hover:text-blue-800 transition-colors">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteDatabaseTransaction(${transaction.id})" class="text-red-600 hover:text-red-800 transition-colors">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('dbTransactionsList').innerHTML = transactionsHtml || 
                '<tr><td colspan="7" class="py-8 text-center text-gray-500">Aucune transaction</td></tr>';
        }

        function loadDatabaseClients() {
            const clientsHtml = clients.map(client => {
                return `
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-3 px-4 text-sm text-gray-600">${client.id}</td>
                        <td class="py-3 px-4 text-sm text-gray-800">${client.name}</td>
                        <td class="py-3 px-4 text-sm text-gray-600">${client.phone}</td>
                        <td class="py-3 px-4 text-sm text-gray-600">${client.email || 'Non renseigné'}</td>
                        <td class="py-3 px-4 text-sm text-gray-600">${client.address || 'Non renseignée'}</td>
                        <td class="py-3 px-4 text-sm text-gray-600">${new Date(client.createdAt).toLocaleDateString('fr-FR')}</td>
                        <td class="py-3 px-4 text-center">
                            <div class="flex items-center justify-center space-x-2">
                                <button onclick="editDatabaseClient(${client.id})" class="text-blue-600 hover:text-blue-800 transition-colors">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteDatabaseClient(${client.id})" class="text-red-600 hover:text-red-800 transition-colors">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('dbClientsList').innerHTML = clientsHtml || 
                '<tr><td colspan="7" class="py-8 text-center text-gray-500">Aucun client</td></tr>';
        }

        function loadDatabaseCredentials() {
            const storedCredentials = JSON.parse(localStorage.getItem('userCredentials')) || {
                proprietaire: { username: 'admin', password: 'admin' },
                receptionniste: { username: 'user', password: 'user' }
            };

            const credentialsHtml = Object.entries(storedCredentials).map(([role, creds]) => {
                const roleText = role === 'proprietaire' ? 'Propriétaire' : 'Réceptionniste';
                const roleClass = role === 'proprietaire' ? 'text-blue-600' : 'text-green-600';

                return `
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-3 px-4 text-sm font-medium ${roleClass}">${roleText}</td>
                        <td class="py-3 px-4 text-sm text-gray-800">${creds.username}</td>
                        <td class="py-3 px-4 text-sm text-gray-600">••••••••</td>
                        <td class="py-3 px-4 text-center">
                            <button onclick="editDatabaseCredentials('${role}')" class="text-blue-600 hover:text-blue-800 transition-colors">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('dbCredentialsList').innerHTML = credentialsHtml;
        }

        function loadDatabaseLogs() {
            const logs = JSON.parse(localStorage.getItem('activityLogs')) || [];
            
            const logsHtml = logs.map(log => {
                const date = new Date(log.timestamp);
                const roleClass = log.role === 'proprietaire' ? 'text-blue-600' : 'text-green-600';
                
                return `
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-3 px-4 text-sm text-gray-600">${log.id}</td>
                        <td class="py-3 px-4 text-sm text-gray-600">
                            ${date.toLocaleDateString('fr-FR')} ${date.toLocaleTimeString('fr-FR')}
                        </td>
                        <td class="py-3 px-4 text-sm font-medium text-gray-800">${log.user}</td>
                        <td class="py-3 px-4 text-sm ${roleClass}">${log.role}</td>
                        <td class="py-3 px-4 text-sm font-medium text-gray-800">${log.action}</td>
                        <td class="py-3 px-4 text-sm text-gray-600">${log.details}</td>
                        <td class="py-3 px-4 text-center">
                            <button onclick="deleteDatabaseLog(${log.id})" class="text-red-600 hover:text-red-800 transition-colors">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('dbLogsList').innerHTML = logsHtml || 
                '<tr><td colspan="7" class="py-8 text-center text-gray-500">Aucun log d\'activité</td></tr>';
        }

        // CRUD Functions for Database Management
        function addNewReservation() {
            openReservationModal('08:00-08:30');
        }

        function addNewTransaction() {
            // Ouvrir un modal pour ajouter une transaction
            const description = prompt('Description de la transaction :');
            if (!description) return;

            const amount = parseFloat(prompt('Montant (€) :'));
            if (!amount || amount <= 0) return;

            const type = confirm('Cliquez OK pour une RECETTE, Annuler pour une DÉPENSE') ? 'income' : 'expense';
            
            const transaction = {
                id: Date.now(),
                date: new Date().toISOString().split('T')[0],
                type: type,
                description: description,
                amount: amount,
                category: type === 'income' ? 'reservation' : 'other'
            };

            transactions.push(transaction);
            localDB.saveData();
            loadDatabaseTransactions();
            logActivity('Ajout transaction DB', `${description} - ${amount}€`);
        }

        function addNewClient() {
            openClientModal();
        }

        function editDatabaseReservation(id) {
            const reservation = reservations.find(r => r.id === id);
            if (!reservation) return;

            const newClient = prompt('Nom du client :', reservation.client);
            if (newClient === null) return;

            const newPhone = prompt('Téléphone :', reservation.phone);
            if (newPhone === null) return;

            const newAmount = parseFloat(prompt('Montant (€) :', reservation.amount));
            if (newAmount === null || newAmount <= 0) return;

            const newPaid = confirm(`Réservation payée ?\n\nActuel : ${reservation.paid ? 'Oui' : 'Non'}`);

            // Mettre à jour la réservation
            reservation.client = newClient;
            reservation.phone = newPhone;
            reservation.amount = newAmount;
            reservation.paid = newPaid;

            localDB.saveData();
            loadDatabaseReservations();
            logActivity('Modification réservation DB', `ID ${id} - ${newClient}`);
        }

        function editDatabaseTransaction(id) {
            const transaction = transactions.find(t => t.id === id);
            if (!transaction) return;

            const newDescription = prompt('Description :', transaction.description);
            if (newDescription === null) return;

            const newAmount = parseFloat(prompt('Montant (€) :', transaction.amount));
            if (newAmount === null || newAmount <= 0) return;

            transaction.description = newDescription;
            transaction.amount = newAmount;

            localDB.saveData();
            loadDatabaseTransactions();
            logActivity('Modification transaction DB', `ID ${id} - ${newDescription}`);
        }

        function editDatabaseClient(id) {
            const client = clients.find(c => c.id === id);
            if (!client) return;

            const newName = prompt('Nom :', client.name);
            if (newName === null) return;

            const newPhone = prompt('Téléphone :', client.phone);
            if (newPhone === null) return;

            const newEmail = prompt('Email :', client.email || '');

            client.name = newName;
            client.phone = newPhone;
            client.email = newEmail;

            localDB.saveData();
            loadDatabaseClients();
            logActivity('Modification client DB', `ID ${id} - ${newName}`);
        }

        function editDatabaseCredentials(role) {
            const storedCredentials = JSON.parse(localStorage.getItem('userCredentials')) || {
                proprietaire: { username: 'admin', password: 'admin' },
                receptionniste: { username: 'user', password: 'user' }
            };

            const roleText = role === 'proprietaire' ? 'Propriétaire' : 'Réceptionniste';
            const newUsername = prompt(`Nouveau nom d'utilisateur ${roleText} :`, storedCredentials[role].username);
            if (newUsername === null) return;

            const newPassword = prompt(`Nouveau mot de passe ${roleText} :`, storedCredentials[role].password);
            if (newPassword === null) return;

            storedCredentials[role] = { username: newUsername, password: newPassword };
            localStorage.setItem('userCredentials', JSON.stringify(storedCredentials));

            loadDatabaseCredentials();
            logActivity('Modification identifiants DB', `${roleText} - ${newUsername}`);
        }

        function deleteDatabaseReservation(id) {
            if (confirm('Supprimer cette réservation ?')) {
                reservations = reservations.filter(r => r.id !== id);
                localDB.saveData();
                loadDatabaseReservations();
                logActivity('Suppression réservation DB', `ID ${id}`);
            }
        }

        function deleteDatabaseTransaction(id) {
            if (confirm('Supprimer cette transaction ?')) {
                transactions = transactions.filter(t => t.id !== id);
                localDB.saveData();
                loadDatabaseTransactions();
                logActivity('Suppression transaction DB', `ID ${id}`);
            }
        }

        function deleteDatabaseClient(id) {
            const client = clients.find(c => c.id === id);
            if (client && confirm(`Supprimer le client "${client.name}" et toutes ses réservations ?`)) {
                clients = clients.filter(c => c.id !== id);
                reservations = reservations.filter(r => r.clientId !== id);
                localDB.saveData();
                loadDatabaseClients();
                logActivity('Suppression client DB', `ID ${id} - ${client.name}`);
            }
        }

        function deleteDatabaseLog(id) {
            if (confirm('Supprimer ce log ?')) {
                const logs = JSON.parse(localStorage.getItem('activityLogs')) || [];
                const filteredLogs = logs.filter(log => log.id !== id);
                localStorage.setItem('activityLogs', JSON.stringify(filteredLogs));
                loadDatabaseLogs();
                logActivity('Suppression log DB', `ID ${id}`);
            }
        }

        function clearAllLogs() {
            if (confirm('Supprimer TOUS les logs d\'activité ?')) {
                localStorage.removeItem('activityLogs');
                loadDatabaseLogs();
                logActivity('Suppression tous logs DB', 'Tous les logs supprimés');
            }
        }

        function exportTable(tableName) {
            let data = [];
            let fileName = '';

            switch(tableName) {
                case 'reservations':
                    data = reservations.map(r => ({
                        ID: r.id,
                        Date: new Date(r.date).toLocaleDateString('fr-FR'),
                        Heure: r.time,
                        Client: r.client,
                        Téléphone: r.phone,
                        Montant: r.amount,
                        Payé: r.paid ? 'Oui' : 'Non'
                    }));
                    fileName = 'Reservations_DB';
                    break;
                case 'transactions':
                    data = transactions.map(t => ({
                        ID: t.id,
                        Date: new Date(t.date).toLocaleDateString('fr-FR'),
                        Type: t.type === 'income' ? 'Recette' : 'Dépense',
                        Description: t.description,
                        Catégorie: t.category,
                        Montant: t.amount
                    }));
                    fileName = 'Transactions_DB';
                    break;
                case 'clients':
                    data = clients.map(c => ({
                        ID: c.id,
                        Nom: c.name,
                        Téléphone: c.phone,
                        Email: c.email || '',
                        Adresse: c.address || '',
                        'Créé le': new Date(c.createdAt).toLocaleDateString('fr-FR')
                    }));
                    fileName = 'Clients_DB';
                    break;
                case 'credentials':
                    const creds = JSON.parse(localStorage.getItem('userCredentials')) || {};
                    data = Object.entries(creds).map(([role, cred]) => ({
                        Rôle: role === 'proprietaire' ? 'Propriétaire' : 'Réceptionniste',
                        'Nom d\'utilisateur': cred.username,
                        'Mot de passe': cred.password
                    }));
                    fileName = 'Identifiants_DB';
                    break;
                case 'logs':
                    const logs = JSON.parse(localStorage.getItem('activityLogs')) || [];
                    data = logs.map(l => ({
                        ID: l.id,
                        'Date/Heure': new Date(l.timestamp).toLocaleString('fr-FR'),
                        Utilisateur: l.user,
                        Rôle: l.role,
                        Action: l.action,
                        Détails: l.details
                    }));
                    fileName = 'Logs_DB';
                    break;
            }

            if (data.length === 0) {
                alert('Aucune donnée à exporter.');
                return;
            }

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, tableName);
            XLSX.writeFile(wb, `${fileName}_${new Date().toISOString().split('T')[0]}.xlsx`);

            logActivity('Export table DB', `Table ${tableName} exportée`);
        }



        // Fonction pour mettre à jour instantanément un nouveau créneau réservé
        function updateNewReservationSlot(slotTime, clientName, isPaid) {
            const slotId = `slot-${slotTime.replace(/[:-]/g, '')}`;
            const slotElement = document.getElementById(slotId);
            
            if (slotElement) {
                // Animation de transition fluide
                slotElement.style.transform = 'scale(0.95)';
                slotElement.style.opacity = '0.7';
                
                setTimeout(() => {
                    const newClass = isPaid ? 'slot-paid' : 'slot-reserved';
                    const newText = isPaid ? 'Payé' : 'Réservé';
                    
                    slotElement.className = slotElement.className.replace(/slot-(free|paid|reserved)/, newClass);
                    slotElement.innerHTML = `
                        <div class="flex items-center justify-between">
                            <h4 class="font-semibold">${slotTime}</h4>
                            <i class="fas fa-futbol transition-transform duration-100 hover:rotate-12"></i>
                        </div>
                        <p class="text-white text-sm mt-1">${clientName}</p>
                        <div class="mt-3">
                            <span class="text-sm opacity-90 transition-opacity duration-100 hover:opacity-100">${newText}</span>
                        </div>
                    `;
                    
                    // Animation de retour avec effet de "pop"
                    slotElement.style.transform = 'scale(1.05)';
                    slotElement.style.opacity = '1';
                    
                    setTimeout(() => {
                        slotElement.style.transform = 'scale(1)';
                    }, 100);
                }, 150);
            }
        }

        // Fonction pour mettre à jour instantanément le statut d'un créneau
        function updateSlotStatusInstantly(reservation) {
            const slotId = `slot-${reservation.time.replace(/[:-]/g, '')}`;
            const slotElement = document.getElementById(slotId);
            
            if (slotElement) {
                // Animation de transition fluide
                slotElement.style.transform = 'scale(0.95)';
                slotElement.style.opacity = '0.7';
                
                setTimeout(() => {
                    // Déterminer le nouveau statut
                    const currentReservation = reservations.find(r => r.id === reservation.id);
                    
                    if (!currentReservation) {
                        // Réservation annulée - retour à libre
                        slotElement.className = slotElement.className.replace(/slot-(paid|reserved)/, 'slot-free');
                        slotElement.onclick = () => openReservationModal(reservation.time);
                        slotElement.innerHTML = `
                            <div class="flex items-center justify-between">
                                <h4 class="font-semibold">${reservation.time}</h4>
                                <i class="fas fa-futbol transition-transform duration-100 hover:rotate-12"></i>
                            </div>
                            <div class="mt-3">
                                <span class="text-sm opacity-90 transition-opacity duration-100 hover:opacity-100">Réserver</span>
                            </div>
                        `;
                    } else if (currentReservation.paid) {
                        // Marqué comme payé
                        slotElement.className = slotElement.className.replace(/slot-(free|reserved)/, 'slot-paid');
                        slotElement.onclick = () => viewReservation(currentReservation.id);
                        slotElement.innerHTML = `
                            <div class="flex items-center justify-between">
                                <h4 class="font-semibold">${reservation.time}</h4>
                                <i class="fas fa-futbol transition-transform duration-100 hover:rotate-12"></i>
                            </div>
                            <p class="text-white text-sm mt-1">${currentReservation.client}</p>
                            ${currentReservation.isConsecutive ? `<p class="text-white text-xs opacity-75">${currentReservation.slotNumber}/${currentReservation.totalSlots}</p>` : ''}
                            <div class="mt-3">
                                <span class="text-sm opacity-90 transition-opacity duration-100 hover:opacity-100">Payé</span>
                            </div>
                        `;
                    }
                    
                    // Animation de retour
                    slotElement.style.transform = 'scale(1)';
                    slotElement.style.opacity = '1';
                }, 150);
            }
        }

        // Event listeners
        document.getElementById('reservationDate').addEventListener('change', loadReservations);
        document.getElementById('historyStartDate').addEventListener('change', loadHistorique);
        document.getElementById('historyEndDate').addEventListener('change', loadHistorique);
        document.getElementById('historyFilter').addEventListener('change', loadHistorique);
        document.getElementById('periodFilter').addEventListener('change', updatePeriodInputs);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96ea57da04a33575',t:'MTc1NTExMDQ1MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
